<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ชั่วโมงบินคงเหลือ - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #4285f4;
            --background-color: #f0f4f8;
            --card-color: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --danger-color: #ff3b30;
            --highlight-color: #ffeb3b;
            --gradient-start: #1a73e8;
            --gradient-end: #4285f4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .date-selector {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            background-color: white;
            padding: 6px 8px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            font-size: 0.8rem;
        }
        
        .filter-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            margin-left: auto;
        }
        
        .filter-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 3px;
            transition: background-color 0.3s;
            height: 24px;
        }
        
        .filter-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .filter-btn.active {
            background-color: #0d47a1;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            background-color: white;
            height: 24px;
        }
        
        .search-box input {
            border: none;
            padding: 2px 5px;
            font-size: 0.75rem;
            width: 100px;
        }
        
        .search-box button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 2px 5px;
            cursor: pointer;
            height: 100%;
            font-size: 0.75rem;
        }

        .date-selector label {
            margin-right: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .date-selector input[type="date"] {
            padding: 2px 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 0.8rem;
            height: 24px;
        }

        .date-selector button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            height: 24px;
            font-size: 0.8rem;
        }

        .date-selector button:hover {
            background-color: var(--secondary-color);
        }

        .dashboard {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: var(--card-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-summary {
            display: flex;
            justify-content: space-between;
            background-color: var(--card-color);
            border-radius: 6px;
            padding: 6px 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .summary-card {
            flex: 1;
            min-width: 120px;
            background: linear-gradient(135deg, #f5f7fa, #e4e8f0);
            border-radius: 4px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
        }
        
        .summary-card.available {
            background: linear-gradient(135deg, #e6f7ee, #d0f0e0);
            border-left: 2px solid var(--success-color);
        }
        
        .summary-card.unavailable {
            background: linear-gradient(135deg, #ffeaea, #ffe0e0);
            border-left: 2px solid var(--danger-color);
        }
        
        .summary-card.total {
            background: linear-gradient(135deg, #e8f0fe, #d4e4fd);
            border-left: 2px solid var(--primary-color);
        }
        
        .summary-title {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        
        .summary-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .summary-icon {
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: var(--primary-color);
            background-color: rgba(26, 115, 232, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .summary-card.available .summary-icon {
            color: var(--success-color);
            background-color: rgba(52, 199, 89, 0.1);
        }
        
        .summary-card.unavailable .summary-icon {
            color: var(--danger-color);
            background-color: rgba(255, 59, 48, 0.1);
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            font-weight: bold;
            text-align: left;
            padding: 6px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
        }
        
        .sort-controls {
            display: flex;
            gap: 4px;
        }
        
        .sort-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 2px 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 3px;
            height: 22px;
        }
        
        .sort-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .sort-btn.active {
            background-color: rgba(255, 255, 255, 0.4);
        }
        
        .closest-date-notice {
            font-size: 0.7rem;
            color: #f8d7da;
            background-color: rgba(220, 53, 69, 0.2);
            padding: 1px 4px;
            border-radius: 3px;
            margin-top: 3px;
            display: inline-block;
        }

        .dashboard-row {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
            position: relative;
            flex-wrap: nowrap;
            overflow: hidden;
        }
        
        .dashboard-row[data-status='yes'] {
            background: linear-gradient(to right, rgba(52, 199, 89, 0.2), rgba(52, 199, 89, 0.05));
        }
        
        .dashboard-row[data-status='no'] {
            background: linear-gradient(to right, rgba(255, 59, 48, 0.2), rgba(255, 59, 48, 0.05));
        }
        
        .dashboard-row::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: transparent;
            transition: background-color 0.2s;
        }
        
        .dashboard-row[data-status='yes']::before {
            background-color: var(--success-color);
        }
        
        .dashboard-row[data-status='no']::before {
            background-color: var(--danger-color);
        }
        
        .dashboard-row:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            z-index: 1;
        }

        .dashboard-row:last-child {
            border-bottom: none;
        }

        .dashboard-row:hover {
            background-color: var(--background-color);
        }

        .dashboard-row.even:not([data-status='yes']):not([data-status='no']) {
            background-color: rgba(0, 0, 0, 0.01);
        }

        .aircraft-image {
            width: 50px;
            height: 40px;
            object-fit: contain;
            margin-right: 8px;
            border-radius: 4px;
            background-color: #f8f8f8;
            padding: 2px;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .aircraft-info {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 6px;
            overflow: hidden;
            min-width: 0;
            margin-right: 8px;
        }

        .aircraft-name-container {
            min-width: 100px;
            max-width: 120px;
            flex-shrink: 0;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .aircraft-name {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .aircraft-number {
            font-size: 0.7rem;
            color: var(--primary-color);
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .aircraft-details {
            display: flex;
            flex-wrap: nowrap;
            gap: 4px;
            align-items: center;
            overflow: hidden;
            flex: 1;
            min-width: 0;
        }

        .info-item {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            background-color: rgba(0, 0, 0, 0.02);
            padding: 2px 4px;
            border-radius: 3px;
            margin-right: 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .hours-item {
            min-width: 140px;
            text-align: center;
            background: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(66, 133, 244, 0.2));
            font-weight: bold;
            justify-content: center;
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .mission-item {
            min-width: 100px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0.06));
            border-radius: 4px;
            border-left: 3px solid #666;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .info-label {
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.65rem;
        }

        .info-value {
            font-size: 0.75rem;
        }

        .hours-value {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--primary-color);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            line-height: 1.2;
        }
        
        .hours-value strong {
            font-size: 1rem;
            color: #0d47a1;
        }
        
        .hours-diff {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 1px 5px;
            border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .diff-item {
            min-width: 60px;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 4px;
        }
        
        .hours-diff.positive {
            color: white;
            background-color: var(--success-color);
        }
        
        .hours-diff.negative {
            color: white;
            background-color: var(--danger-color);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 1px 4px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 500;
            margin-left: 4px;
            flex-shrink: 0;
        }

        .status-available {
            background-color: rgba(52, 199, 89, 0.15);
            color: var(--success-color);
            border: 1px solid rgba(52, 199, 89, 0.3);
        }

        .status-unavailable {
            background-color: rgba(255, 59, 48, 0.15);
            color: var(--danger-color);
            border: 1px solid rgba(255, 59, 48, 0.3);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .error-message {
            background-color: #ffebee;
            color: var(--danger-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: var(--secondary-color);
        }

        /* สไตล์สำหรับอุปกรณ์แท็บเล็ต */
        @media (max-width: 992px) {
            .container {
                padding: 15px;
            }
            
            .filter-controls {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            
            .dashboard-summary {
                flex-wrap: wrap;
            }
            
            .summary-card {
                min-width: 150px;
                margin-bottom: 10px;
            }
            
            .aircraft-details {
                flex-wrap: wrap;
            }
        }
        
        /* สไตล์สำหรับอุปกรณ์มือถือ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                width: 100%;
                max-width: 100%;
            }

            header .container {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            
            h1 {
                font-size: 1.5rem;
                margin-bottom: 15px;
                width: 100%;
                text-align: center;
            }
            
            .back-button {
                margin-top: 10px;
                padding: 8px 12px;
                font-size: 0.9rem;
                align-self: center;
            }

            .date-selector {
                flex-direction: column;
                align-items: flex-start;
                padding: 8px;
                width: 100%;
            }

            .date-selector label, .date-selector input {
                margin: 5px 0;
                width: 100%;
                font-size: 0.9rem;
            }
            
            .date-selector input[type="date"] {
                padding: 8px;
                border-radius: 6px;
                border: 1px solid var(--border-color);
                height: 40px;
                background-color: white;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .date-selector button {
                margin: 8px 0 5px 0;
                width: 100%;
                padding: 10px;
                font-size: 0.9rem;
                height: 40px;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                transition: background-color 0.3s, transform 0.2s;
            }
            
            .date-selector button:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            }
            
            .filter-controls {
                width: 100%;
                margin-top: 10px;
                gap: 6px;
                display: flex;
                flex-wrap: wrap;
            }
            
            .search-box {
                width: 100%;
                margin-bottom: 8px;
                height: 40px;
                border-radius: 6px;
                overflow: hidden;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .search-box input {
                width: 100%;
                padding: 10px;
                font-size: 0.9rem;
                border: 1px solid var(--border-color);
                border-radius: 6px 0 0 6px;
                height: 100%;
            }
            
            .search-box button {
                height: 100%;
                padding: 0 12px;
                font-size: 0.9rem;
            }
            
            .filter-btn {
                flex: 1 1 calc(50% - 6px);
                padding: 8px 5px;
                font-size: 0.8rem;
                height: 36px;
                justify-content: center;
                border-radius: 6px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                transition: background-color 0.3s, transform 0.2s;
            }
            
            .filter-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            }
            
            .dashboard-summary {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px;
                justify-content: space-between;
            }
            
            .summary-card {
                flex: 1 1 calc(33.33% - 8px);
                min-width: 100px;
                padding: 10px;
                border-radius: 8px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .summary-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }
            
            .summary-value {
                font-size: 1.6rem;
                margin-top: 5px;
            }
            
            .summary-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
                margin-bottom: 6px;
            }

            .dashboard-row {
                flex-direction: row;
                align-items: center;
                padding: 8px 10px;
                margin-bottom: 6px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                min-height: 40px;
                overflow: hidden;
                position: relative;
                flex-wrap: nowrap;
                width: 100%;
            }
            
            .dashboard-header {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
                border-radius: 8px 8px 0 0;
                width: 100%;
            }
            
            .sort-controls {
                margin-top: 6px;
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .sort-btn {
                flex: 1 1 auto;
                margin: 2px;
                padding: 5px 8px;
                font-size: 0.7rem;
                justify-content: center;
                height: 28px;
                border-radius: 4px;
            }

            /* แถวแรกสำหรับข้อมูลหลัก */
            .aircraft-main-row {
                display: flex;
                width: 100%;
                align-items: center;
                flex-wrap: nowrap;
                gap: 6px;
            }

            .aircraft-info {
                display: flex;
                align-items: center;
                flex: 1;
                margin-bottom: 0;
                flex-direction: row;
                flex-wrap: nowrap;
                overflow: hidden;
                width: 100%;
            }
            
            .aircraft-image {
                margin-right: 10px;
                margin-bottom: 0;
                width: 45px;
                height: 35px;
                flex-shrink: 0;
                object-fit: contain;
                border-radius: 6px;
                border: 1px solid var(--border-color);
                background-color: white;
                padding: 2px;
            }
            
            .aircraft-name-container {
                min-width: 0;
                max-width: calc(100% - 50px);
                flex: 1;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }
            
            .aircraft-name {
                font-size: 0.9rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-bottom: 3px;
                font-weight: bold;
            }
            
            .aircraft-number {
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                color: var(--primary-color);
                background-color: rgba(26, 115, 232, 0.1);
                padding: 2px 5px;
                border-radius: 4px;
                display: inline-block;
            }
            
            .status-indicator {
                font-size: 0.75rem;
                padding: 3px 6px;
                margin-left: 6px;
                flex-shrink: 0;
                border-radius: 12px;
                background-color: rgba(0, 0, 0, 0.05);
                width: 32px;
                height: 32px;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .status-indicator.status-available {
                background-color: rgba(52, 199, 89, 0.2);
                color: var(--success-color);
                border: 1px solid rgba(52, 199, 89, 0.3);
            }
            
            .status-indicator.status-unavailable {
                background-color: rgba(255, 59, 48, 0.2);
                color: var(--danger-color);
                border: 1px solid rgba(255, 59, 48, 0.3);
            }

            /* ไม่ใช้แถวที่สองในโหมดปกติ */
            .aircraft-details-row {
                display: none;
            }
            
            .info-item {
                display: flex;
                align-items: center;
                background-color: rgba(0, 0, 0, 0.03);
                padding: 4px 8px;
                border-radius: 6px;
                margin-right: 6px;
                font-size: 0.75rem;
                white-space: nowrap;
                flex-shrink: 0;
                min-height: 24px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            }
            
            .info-label {
                color: var(--text-secondary);
                margin-right: 4px;
                font-size: 0.7rem;
            }
            
            .info-value {
                font-weight: bold;
                font-size: 0.75rem;
            }
            
            /* ชั่วโมงบิน */
            .hours-item {
                background: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(66, 133, 244, 0.2));
                font-weight: bold;
                color: var(--primary-color);
                min-width: 90px;
                border-left: 3px solid var(--primary-color);
                padding: 5px 10px;
                border-radius: 6px;
                margin-left: auto;
            }
            
            .hours-value {
                font-weight: bold;
                color: var(--primary-color);
            }
            
            .hours-diff {
                font-size: 0.7rem;
                padding: 2px 4px;
                margin-left: 4px;
                border-radius: 8px;
                display: inline-block;
                vertical-align: middle;
                line-height: 1.2;
                font-weight: bold;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            
            .hours-diff.positive {
                color: white;
                background-color: var(--success-color);
            }
            
            .hours-diff.negative {
                color: white;
                background-color: var(--danger-color);
            }
            
            /* ซ่อนลูกศรในโหมดมือถือ */
            @media (max-width: 768px) {
                .dashboard-row::after {
                    display: none;
                }
            }
        }
        
        /* สไตล์สำหรับอุปกรณ์มือถือขนาดเล็ก */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.2rem;
            }
            
            .filter-btn {
                flex: 1 1 100%;
                margin-bottom: 4px;
                height: 36px;
            }
            
            .aircraft-image {
                width: 40px;
                height: 32px;
            }
            
            .hours-item {
                min-width: 80px;
                padding: 4px 6px;
            }
            
            .dashboard-row {
                padding: 6px 8px;
            }
        }
        
        /* สไตล์สำหรับอุปกรณ์มือถือขนาดเล็กมาก */
        @media (max-width: 360px) {
            .container {
                padding: 6px;
            }
            
            h1 {
                font-size: 1.1rem;
            }
            
            .aircraft-name {
                font-size: 0.8rem;
            }
            
            .aircraft-number {
                font-size: 0.7rem;
            }
            
            .aircraft-image {
                width: 36px;
                height: 28px;
                margin-right: 6px;
            }
            
            .status-indicator {
                width: 28px;
                height: 28px;
                font-size: 0.7rem;
            }
            
            .hours-item {
                min-width: 70px;
                padding: 3px 5px;
            }
            
            .info-value {
                font-size: 0.7rem;
            }
            
            .hours-diff {
                font-size: 0.65rem;
                padding: 1px 3px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>สถาณะรายวัน อากาศยานกรมฝนหลวงและการบินเกษตร</h1>
            <a href="index.html" class="back-button"><i class="fas fa-arrow-left"></i> กลับไปหน้าหลัก</a>
        </div>
    </header>

    <div class="container">
        <div class="date-selector">
            <label for="dateSelector">เลือกวันที่:</label>
            <input type="date" id="dateSelector">
            <button id="resetDateBtn"><i class="fas fa-sync-alt"></i> รีเซ็ตเป็นวันนี้</button>
            
            <div class="filter-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ค้นหา..." autocomplete="off">
                </div>
                <button class="filter-btn active" data-filter="all"><i class="fas fa-list"></i> ทั้งหมด</button>
                <button class="filter-btn" data-filter="available"><i class="fas fa-check-circle"></i> พร้อมใช้งาน</button>
                <button class="filter-btn" data-filter="unavailable"><i class="fas fa-times-circle"></i> ไม่พร้อมใช้งาน</button>
                <button class="filter-btn" data-filter="aircraft"><i class="fas fa-plane"></i> เครื่องบิน</button>
                <button class="filter-btn" data-filter="helicopter"><i class="fas fa-helicopter"></i> เฮลิคอปเตอร์</button>
            </div>
        </div>

        <div id="dashboardSummary" class="dashboard-summary">
            <div class="summary-card total">
                <div class="summary-icon"><i class="fas fa-plane"></i></div>
                <div class="summary-title">เครื่องบินทั้งหมด</div>
                <div id="totalAircraft" class="summary-value">0</div>
            </div>
            <div class="summary-card available">
                <div class="summary-icon"><i class="fas fa-check-circle"></i></div>
                <div class="summary-title">พร้อมใช้งาน</div>
                <div id="availableAircraft" class="summary-value">0</div>
            </div>
            <div class="summary-card unavailable">
                <div class="summary-icon"><i class="fas fa-times-circle"></i></div>
                <div class="summary-title">ไม่พร้อมใช้งาน</div>
                <div id="unavailableAircraft" class="summary-value">0</div>
            </div>
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="dashboard" class="dashboard">
            <div class="loading">กำลังโหลดข้อมูล...</div>
        </div>
    </div>

    <script>
        // ตัวแปรเก็บข้อมูลเครื่องบิน
        let flightData = [];
        
        // ตัวแปรเก็บข้อมูลวันถัดไป
        window.nextDayData = [];
        window.nextDayDate = null;
        
        // ตัวแปรเก็บจำนวนมาร์กเกอร์ในแต่ละตำแหน่ง
        const positionCounts = {};
        
        // ตัวแปรเก็บพิกัดของแต่ละจังหวัด
        const provinceCoordinates = {
            "กรุงเทพมหานคร": [13.9126, 100.6068], // ท่าอากาศยานดอนเมือง
            "กระบี่": [8.0993, 98.9786], // ท่าอากาศยานนานาชาติกระบี่
            "กาญจนบุรี": [14.0039, 99.5501], // ไม่มีสนามบิน
            "กาฬสินธุ์": [16.4380, 103.5060], // ไม่มีสนามบิน
            "กำแพงเพชร": [16.4828, 99.5220], // ไม่มีสนามบิน
            "ขอนแก่น": [16.4666, 102.7836], // ท่าอากาศยานขอนแก่น
            "จันทบุรี": [12.6180, 102.1063], // สนามบินท่าใหม่
            "ฉะเชิงเทรา": [13.6904, 101.0779], // ไม่มีสนามบิน
            "ชลบุรี": [12.6799, 101.0046], // ท่าอากาศยานอู่ตะเภา
            "ชัยนาท": [15.1856, 100.1250], // ไม่มีสนามบิน
            "ชัยภูมิ": [15.8052, 102.0310], // ไม่มีสนามบิน
            "ชุมพร": [10.7112, 99.3616], // ท่าอากาศยานชุมพร
            "เชียงราย": [19.9553, 99.8829], // ท่าอากาศยานแม่ฟ้าหลวง เชียงราย
            "เชียงใหม่": [18.7666, 98.9620], // ท่าอากาศยานเชียงใหม่
            "ตรัง": [7.5086, 99.6166], // ท่าอากาศยานตรัง
            "ตราด": [12.2746, 102.3190], // ท่าอากาศยานตราด
            "ตาก": [16.8961, 99.2530], // ไม่มีสนามบิน
            "นครนายก": [14.0859, 101.2311], // ไม่มีสนามบิน
            "นครปฐม": [13.8198, 100.0401], // ไม่มีสนามบิน
            "นครพนม": [17.3973, 104.7754], // ท่าอากาศยานนครพนม
            "นครราชสีมา": [14.9498, 102.3130], // ท่าอากาศยานนครราชสีมา
            "นครศรีธรรมราช": [8.5396, 99.9447], // ท่าอากาศยานนครศรีธรรมราช
            "นครสวรรค์": [15.7112, 100.1153], // ไม่มีสนามบิน
            "นนทบุรี": [13.9074, 100.5211], // ไม่มีสนามบิน
            "นราธิวาส": [6.7814, 101.6747], // ท่าอากาศยานนราธิวาส
            "น่าน": [18.8078, 100.7829], // ท่าอากาศยานน่านนคร
            "บึงกาฬ": [18.3609, 103.6465], // ไม่มีสนามบิน
            "บุรีรัมย์": [14.9956, 103.1059], // ท่าอากาศยานบุรีรัมย์
            "ปทุมธานี": [14.0208, 100.5255], // ไม่มีสนามบิน
            "ประจวบคีรีขันธ์": [11.8335, 99.8000], // ท่าอากาศยานหัวหิน
            "ปราจีนบุรี": [14.0589, 101.3759], // ไม่มีสนามบิน
            "ปัตตานี": [6.8688, 101.2500], // ไม่มีสนามบิน
            "พระนครศรีอยุธยา": [14.3532, 100.5683], // ไม่มีสนามบิน
            "พะเยา": [19.1664, 99.9003], // ไม่มีสนามบิน
            "พังงา": [8.4543, 98.5255], // ไม่มีสนามบิน
            "พัทลุง": [7.6166, 100.0830], // ไม่มีสนามบิน
            "พิจิตร": [16.4429, 100.3496], // ไม่มีสนามบิน
            "พิษณุโลก": [16.7834, 100.2694], // ท่าอากาศยานพิษณุโลก
            "เพชรบุรี": [13.1133, 99.9433], // ไม่มีสนามบิน
            "เพชรบูรณ์": [16.4211, 101.1591], // ไม่มีสนามบิน
            "แพร่": [18.1445, 100.1400], // ท่าอากาศยานแพร่
            "ภูเก็ต": [7.9911, 98.2978], // ท่าอากาศยานนานาชาติภูเก็ต
            "มหาสารคาม": [16.1851, 103.3030], // ไม่มีสนามบิน
            "มุกดาหาร": [16.5422, 104.7220], // ไม่มีสนามบิน
            "แม่ฮ่องสอน": [19.3012, 97.9650], // ท่าอากาศยานแม่ฮ่องสอน
            "ยโสธร": [15.7927, 104.1452], // ไม่มีสนามบิน
            "ยะลา": [6.5413, 101.2800], // ไม่มีสนามบิน
            "ร้อยเอ็ด": [16.0557, 103.6520], // ท่าอากาศยานร้อยเอ็ด
            "ระนอง": [9.9528, 98.6084], // ท่าอากาศยานระนอง
            "ระยอง": [12.6799, 101.0046], // ท่าอากาศยานอู่ตะเภา
            "ราชบุรี": [13.5282, 99.8133], // ไม่มีสนามบิน
            "ลพบุรี": [14.7995, 100.6540], // ท่าอากาศยานทหารลพบุรี
            "ลำปาง": [18.2816, 99.5044], // ท่าอากาศยานลำปาง
            "ลำพูน": [18.5744, 99.0087], // ไม่มีสนามบิน
            "เลย": [17.4860, 101.7200], // ท่าอากาศยานเลย
            "ศรีสะเกษ": [15.1186, 104.3200], // ไม่มีสนามบิน
            "สกลนคร": [17.1546, 104.1348], // ท่าอากาศยานสกลนคร
            "สงขลา": [7.1952, 100.5986], // ท่าอากาศยานนานาชาติหาดใหญ่
            "สตูล": [6.6238, 100.0670], // ไม่มีสนามบิน
            "สมุทรปราการ": [13.5990, 100.5998], // ท่าอากาศยานสุวรรณภูมิ
            "สมุทรสงคราม": [13.4125, 100.0020], // ไม่มีสนามบิน
            "สมุทรสาคร": [13.5475, 100.2747], // ไม่มีสนามบิน
            "สระแก้ว": [13.8240, 102.0645], // ไม่มีสนามบิน
            "สระบุรี": [14.5289, 100.9108], // ไม่มีสนามบิน
            "สิงห์บุรี": [14.8907, 100.4081], // ไม่มีสนามบิน
            "สุโขทัย": [17.0100, 99.8265], // ท่าอากาศยานสุโขทัย
            "สุพรรณบุรี": [14.4742, 100.1177], // ไม่มีสนามบิน
            "สุราษฎร์ธานี": [9.1079, 99.2812], // ท่าอากาศยานสุราษฎร์ธานี
            "สุรินทร์": [14.8820, 103.4960], // ท่าอากาศยานสุรินทร์
            "หนองคาย": [17.8782, 102.7418], // ไม่มีสนามบิน
            "หนองบัวลำภู": [17.2220, 102.4260], // ไม่มีสนามบิน
            "อ่างทอง": [14.5896, 100.4550], // ไม่มีสนามบิน
            "อำนาจเจริญ": [15.8656, 104.6290], // ไม่มีสนามบิน
            "อุดรธานี": [17.3864, 102.7883], // ท่าอากาศยานอุดรธานี
            "อุตรดิตถ์": [17.6200, 100.0990], // ไม่มีสนามบิน
            "อุทัยธานี": [15.3838, 100.0250], // ไม่มีสนามบิน
            "อุบลราชธานี": [15.2523, 104.8700] // ท่าอากาศยานอุบลราชธานี
        };
        
        // ตัวแปรเก็บสถานะการใช้ข้อมูลจากวันที่ใกล้เคียง
        let isUsingNearbyDate = false;
        let nearbyDateUsed = "";
        
        // รายการรูปภาพเครื่องบินแต่ละรุ่น
        const aircraftImages = {
            "SKA-350": "https://www.royalrain.go.th/royalrain/IMG/content/archive/1_SuperKingAir350(SKA350).jpg",
            "CN-235": "https://www.royalrain.go.th/royalrain/IMG/content/archive/2_CN_235-220.jpg",
            "NC 212I": "https://www.royalrain.go.th/royalrain/IMG/content/archive/3_Casa_C212_NC212i.jpg",
            "CASA-400": "https://www.royalrain.go.th/royalrain/IMG/content/archive/3_Casa_C212_NC212i.jpg",
            "CASA-300": "https://www.royalrain.go.th/royalrain/IMG/content/archive/3_Casa_C212_NC212i.jpg",
            "CASA-200": "https://www.royalrain.go.th/royalrain/IMG/content/archive/3_Casa_C212_NC212i.jpg",
            "CARAVAN": "https://www.royalrain.go.th/royalrain/IMG/content/archive/4_Grand_Caravan_Caravan_Cessna_C%E0%B9%92%E0%B9%90%E0%B9%98B.jpg",
            "BELL 412EP": "https://www.royalrain.go.th/royalrain/IMG/content/archive/5_BELL_412EP.jpg",
            "BELL 407GXP": "https://www.royalrain.go.th/royalrain/IMG/content/archive/6_BELL_%E0%B9%94%E0%B9%90%E0%B9%97.jpg",
            "BELL 407": "https://www.royalrain.go.th/royalrain/IMG/content/archive/6_BELL_%E0%B9%94%E0%B9%90%E0%B9%97.jpg",
            "AS350B2": "https://www.royalrain.go.th/royalrain/IMG/content/archive/7_AS%20350_B2_ECUREUIL%20.jpg",
            "BELL 206B": "https://www.royalrain.go.th/royalrain/IMG/content/archive/8_BELL_%E0%B9%92%E0%B9%90%E0%B9%96B.jpg",
            "H130T2": "https://it.royalrain.go.th/aircraft_services/uploads/aircraft/60a15b7d97a3c9e82ff3b1fb89bc49e5.png"
        };
        
        // ฟังก์ชันหารูปภาพที่เหมาะสมสำหรับเครื่องบินแต่ละรุ่น
        function getAircraftImage(aircraft) {
            // ใช้ชื่อเครื่องบินเพื่อกำหนดรูปภาพ
            const aircraftName = (aircraft.name || '').toUpperCase();
            const aircraftNumber = (aircraft.aircraftNumber || '').toString().toUpperCase();
            
            // ตรวจสอบว่ามีรูปภาพสำหรับเครื่องบินรุ่นนี้หรือไม่
            for (const [model, imageUrl] of Object.entries(aircraftImages)) {
                if (aircraftName.includes(model) || aircraftNumber.includes(model)) {
                    return {
                        src: imageUrl,
                        alt: model
                    };
                }
            }
            
            // ถ้าไม่พบรูปภาพที่ตรงกับรุ่น ให้ใช้การตรวจสอบทั่วไป
            if (aircraftName.includes('KING AIR') || aircraftName.includes('SKA') || aircraftNumber.includes('B200')) {
                return {
                    src: 'https://www.royalrain.go.th/royalrain/IMG/content/archive/1_SuperKingAir350(SKA350).jpg',
                    alt: 'King Air'
                };
            } else if (aircraftName.includes('BELL')) {
                return {
                    src: 'https://www.royalrain.go.th/royalrain/IMG/content/archive/5_BELL_412EP.jpg',
                    alt: 'Bell Helicopter'
                };
            } else if (aircraftName.includes('AS350') || aircraftName.includes('H130')) {
                return {
                    src: 'https://www.royalrain.go.th/royalrain/IMG/content/archive/7_AS%20350_B2_ECUREUIL%20.jpg',
                    alt: 'AS350/H130'
                };
            } else if (aircraftName.includes('CARAVAN') || aircraftName.includes('C208')) {
                return {
                    src: 'https://www.royalrain.go.th/royalrain/IMG/content/archive/4_Grand_Caravan_Caravan_Cessna_C%E0%B9%92%E0%B9%90%E0%B9%98B.jpg',
                    alt: 'Caravan'
                };
            } else if (aircraftName.includes('CASA') || aircraftName.includes('NC 212')) {
                return {
                    src: 'https://www.royalrain.go.th/royalrain/IMG/content/archive/3_Casa_C212_NC212i.jpg',
                    alt: 'CASA/NC 212'
                };
            } else if (aircraftName.includes('CN-235')) {
                return {
                    src: 'https://www.royalrain.go.th/royalrain/IMG/content/archive/2_CN_235-220.jpg',
                    alt: 'CN-235'
                };
            } else {
                // ถ้าไม่มีรูปภาพเฉพาะ ให้ใช้รูปภาพทั่วไปตามประเภท
                if (aircraft.type === 'helicopter') {
                    return {
                        src: 'helicopter.svg',
                        alt: 'Helicopter'
                    };
                } else {
                    return {
                        src: 'airplane.svg',
                        alt: 'Aircraft'
                    };
                }
            }
        }

        // ฟังก์ชันแปลงรูปแบบวันที่ให้เป็น YYYY-MM-DD
        function formatDate(dateValue) {
            try {
                // ถ้าเป็น Date object
                if (dateValue instanceof Date) {
                    const year = dateValue.getFullYear();
                    const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                    const day = String(dateValue.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                // ถ้าเป็น string
                if (typeof dateValue === 'string') {
                    // ถ้าเป็นรูปแบบ YYYY-MM-DD อยู่แล้ว
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                        return dateValue;
                    }
                    
                    // ถ้าเป็นรูปแบบ DD/MM/YYYY
                    if (dateValue.includes('/')) {
                        const parts = dateValue.split('/');
                        if (parts.length === 3) {
                            const day = parts[0].padStart(2, '0');
                            const month = parts[1].padStart(2, '0');
                            let year = parts[2];
                            if (year.length === 2) year = `20${year}`;
                            return `${year}-${month}-${day}`;
                        }
                    }
                    
                    // ถ้าเป็นรูปแบบ DD-MM-YYYY
                    if (dateValue.includes('-')) {
                        const parts = dateValue.split('-');
                        if (parts.length === 3) {
                            // ตรวจสอบว่าปีอยู่ตำแหน่งแรกหรือไม่
                            if (parts[0].length === 4) {
                                // เป็นรูปแบบ YYYY-MM-DD อยู่แล้ว
                                return dateValue;
                            } else {
                                // อาจเป็นรูปแบบ DD-MM-YYYY
                                const day = parts[0].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                let year = parts[2];
                                if (year.length === 2) year = `20${year}`;
                                return `${year}-${month}-${day}`;
                            }
                        }
                    }
                    
                    // ถ้าเป็นรูปแบบ Date(YYYY,MM,DD,...)
                    const dateMatch = dateValue.match(/Date\((\d+),(\d+),(\d+)/);
                    if (dateMatch) {
                        const year = parseInt(dateMatch[1]);
                        // เดือนใน JavaScript เริ่มจาก 0 (0 = มกราคม)
                        const month = parseInt(dateMatch[2]) + 1;
                        const day = parseInt(dateMatch[3]);
                        
                        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    }
                }
                
                // ถ้าเป็นตัวเลข (อาจเป็น timestamp หรือ serial date ของ Excel)
                if (typeof dateValue === 'number') {
                    // แปลงเป็น Date object
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return formatDate(date);
                    }
                }
                
                // พยายามแปลงเป็น Date object
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                // ถ้าไม่สามารถแปลงได้
                console.warn(`⚠️ ไม่สามารถแปลงวันที่ได้: ${dateValue}`);
                return null;
            } catch (error) {
                console.error(`❌ เกิดข้อผิดพลาดในการแปลงวันที่ ${dateValue}:`, error);
                return null;
            }
        }
        
        // ฟังก์ชันสำหรับดึงข้อมูลทุกวันที่และเก็บไว้ใน cache
        async function prefetchAllDates() {
            console.log("🔄 เริ่มต้นการดึงข้อมูลทุกวันที่เพื่อเก็บใน cache...");
            
            try {
                const sheetID = "1_M74Pe_4uul0fkcEea8AMxQIMcPznNZ9ttCqvbeQgBs";
                const aircraftSheetGID = "705816349";
                
                // URL สำหรับดึงข้อมูลทั้งหมด
                const aircraftURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&gid=${aircraftSheetGID}`;
                
                // ดึงข้อมูลทั้งหมด
                const response = await fetch(aircraftURL);
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                
                // ตรวจสอบว่ามีข้อมูลหรือไม่
                if (json && json.table && json.table.rows && json.table.rows.length > 0) {
                    console.log(`📊 ดึงข้อมูลจาก Google Sheets สำเร็จ จำนวน ${json.table.rows.length} แถว`);
                    
                    // รายการวันที่ที่พบ
                    const foundDates = [];
                    
                    // วนลูปตรวจสอบทุกแถว
                    for (let i = 0; i < json.table.rows.length; i++) {
                        const row = json.table.rows[i];
                        
                        // ตรวจสอบว่ามีข้อมูลในคอลัมน์ A (วันที่) หรือไม่
                        if (row.c && row.c[0] && row.c[0].v) {
                            // ดึงค่าวันที่จากคอลัมน์ A
                            let rowDate = formatDate(row.c[0].v);
                            
                            // ถ้าสามารถแปลงวันที่ได้ และยังไม่มีในรายการ
                            if (rowDate && !foundDates.includes(rowDate)) {
                                foundDates.push(rowDate);
                                
                                // ตรวจสอบว่ามีข้อมูลใน cache แล้วหรือไม่
                                const cacheKey = `flightDataCache_${rowDate}`;
                                const cachedData = localStorage.getItem(cacheKey);
                                
                                if (cachedData) {
                                    console.log(`📋 มีข้อมูลใน cache สำหรับวันที่ ${rowDate} แล้ว`);
                                } else {
                                    // ดึงข้อมูลสำหรับวันที่นี้และเก็บใน cache
                                    console.log(`📅 กำลังดึงข้อมูลสำหรับวันที่: ${rowDate}`);
                                    try {
                                        await fetchFlightData(rowDate, true); // พารามิเตอร์ที่สองคือ silentMode
                                    } catch (error) {
                                        console.warn(`⚠️ ไม่สามารถดึงข้อมูลสำหรับวันที่ ${rowDate} ได้:`, error);
                                    }
                                }
                            }
                        }
                    }
                    
                    console.log(`✅ ดึงข้อมูลและเก็บใน cache สำเร็จสำหรับ ${foundDates.length} วันที่`);
                }
            } catch (error) {
                console.error("❌ เกิดข้อผิดพลาดในการดึงข้อมูลทุกวันที่:", error);
            }
        }
        
        // เมื่อโหลดหน้าเสร็จ
        document.addEventListener("DOMContentLoaded", async function() {
            console.log("เริ่มต้นแอปพลิเคชัน Dashboard...");
            
            // ตั้งค่าตัวเลือกวันที่
            setupDateSelector();
            
            // โหลดข้อมูลเริ่มต้น (วันนี้)
            await fetchFlightData();
            
            // สร้าง dashboard
            renderDashboard();
            
            // เริ่มดึงข้อมูลทุกวันที่ในพื้นหลัง
            setTimeout(() => {
                prefetchAllDates();
            }, 2000); // รอ 2 วินาทีหลังจากโหลดข้อมูลหลักเสร็จ
        });

        // ฟังก์ชันตั้งค่าตัวเลือกวันที่
        function setupDateSelector() {
            const dateSelector = document.getElementById('dateSelector');
            const resetDateBtn = document.getElementById('resetDateBtn');
            
            if (!dateSelector) {
                console.error('Date selector not found');
                return;
            }
            
            try {
                // ตั้งค่าวันที่เริ่มต้นเป็นวันนี้
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                dateSelector.value = formattedDate;
            } catch (error) {
                console.error('Error setting initial date:', error);
            }

            // เพิ่ม event listener สำหรับการเปลี่ยนวันที่
            dateSelector.addEventListener('change', async function() {
                const selectedDate = dateSelector.value;
                console.log(`เลือกวันที่: ${selectedDate}`);

                try {
                    // ล้างพื้นที่สำหรับแสดงข้อมูลใหม่
                    document.getElementById("dashboard").innerHTML = "";
                    
                    // ซ่อนข้อความแจ้งเตือน
                    document.getElementById("errorMessage").style.display = "none";

                    // โหลดข้อมูลตามวันที่ที่เลือก
                    await fetchFlightData(selectedDate);
                    
                    // สร้าง dashboard ใหม่
                    renderDashboard();
                } catch (error) {
                    console.error("❌ โหลดข้อมูลไม่สำเร็จ:", error);
                    
                    // แสดงข้อความแจ้งเตือนที่เฉพาะเจาะจงมากขึ้น
                    let errorMsg = "ไม่สามารถโหลดข้อมูลได้";
                    let availableDatesForUser = [];
                    
                    // ตรวจสอบประเภทของข้อผิดพลาด
                    if (error.message && error.message.includes("ไม่พบข้อมูลสำหรับวันที่")) {
                        // ตรวจสอบว่าเป็นวันที่ในอนาคตหรือไม่
                        const selectedDateObj = new Date(selectedDate);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0); // รีเซ็ตเวลาเป็น 00:00:00
                        
                        if (selectedDateObj > today) {
                            errorMsg = `ไม่พบข้อมูลสำหรับวันที่ ${selectedDate} (วันที่ในอนาคต) กรุณาเลือกวันที่อื่น`;
                        } else {
                            errorMsg = `ไม่พบข้อมูลสำหรับวันที่ ${selectedDate} กรุณาเลือกวันที่อื่น`;
                        }
                        
                        // ดึงรายการวันที่ที่มีข้อมูลจาก localStorage
                        const allDatesKey = 'allCachedDates';
                        try {
                            const cachedDates = localStorage.getItem(allDatesKey);
                            if (cachedDates) {
                                availableDatesForUser = JSON.parse(cachedDates);
                                availableDatesForUser.sort(); // เรียงลำดับวันที่
                            }
                        } catch (e) {
                            console.error("ไม่สามารถดึงรายการวันที่ได้:", e);
                        }
                    } else if (error.message && (error.message.includes("NetworkError") || error.message.includes("Failed to fetch"))) {
                        errorMsg = "ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต";
                    }
                    
                    // สร้างรายการวันที่ที่มีข้อมูลให้ผู้ใช้เลือก
                    let dateButtons = '';
                    if (availableDatesForUser.length > 0) {
                        // แสดงเฉพาะ 5 วันล่าสุด
                        const recentDates = availableDatesForUser.slice(-5).reverse();
                        dateButtons = recentDates.map(date => 
                            `<button class="available-date-btn" onclick="document.getElementById('dateSelector').value='${date}'; document.getElementById('dateSelector').dispatchEvent(new Event('change'));">
                                ${date}
                            </button>`
                        ).join('');
                    }
                    
                    // แสดงข้อความว่าไม่พบข้อมูลในรูปแบบที่ชัดเจน
                    document.getElementById("dashboard").innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <div style="font-size: 3rem; color: #ccc; margin-bottom: 20px;">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                            <div style="font-size: 1.2rem; color: var(--text-secondary);">
                                ${errorMsg}
                            </div>
                            <div style="margin-top: 10px; margin-bottom: 20px; color: var(--text-secondary);">
                                กรุณาเลือกวันที่อื่น หรือกดปุ่ม "รีเซ็ตเป็นวันนี้" เพื่อดูข้อมูลล่าสุด
                            </div>
                            ${availableDatesForUser.length > 0 ? `
                                <div style="margin-top: 20px;">
                                    <div style="margin-bottom: 10px; color: var(--text-secondary);">
                                        <i class="fas fa-calendar-check"></i> วันที่มีข้อมูล:
                                    </div>
                                    <div class="available-dates">
                                        ${dateButtons}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // เพิ่ม CSS สำหรับปุ่มวันที่
                    const style = document.createElement('style');
                    style.textContent = `
                        .available-dates {
                            display: flex;
                            flex-wrap: wrap;
                            justify-content: center;
                            gap: 10px;
                            margin-top: 10px;
                        }
                        .available-date-btn {
                            background-color: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 4px;
                            cursor: pointer;
                            transition: background-color 0.3s;
                        }
                        .available-date-btn:hover {
                            background-color: var(--secondary-color);
                        }
                    `;
                    document.head.appendChild(style);
                    
                    document.getElementById("errorMessage").textContent = errorMsg;
                    document.getElementById("errorMessage").style.display = "block";
                    document.getElementById("dashboard").innerHTML = "";
                }
            });

            if (resetDateBtn) {
                // เพิ่ม event listener สำหรับปุ่มรีเซ็ตวันที่
                resetDateBtn.addEventListener('click', async function() {
                    // ตั้งค่าวันที่เป็นวันนี้
                    const today = new Date();
                    const formattedDate = today.toISOString().split('T')[0];
                    dateSelector.value = formattedDate;

                    try {
                        // ล้างพื้นที่สำหรับแสดงข้อมูลใหม่
                        document.getElementById("dashboard").innerHTML = "";
                        
                        // ซ่อนข้อความแจ้งเตือน
                        document.getElementById("errorMessage").style.display = "none";

                        // โหลดข้อมูลของวันนี้
                        await fetchFlightData();
                        
                        // สร้าง dashboard ใหม่
                        renderDashboard();
                    } catch (error) {
                        console.error("เกิดข้อผิดพลาดในการโหลดข้อมูลวันนี้:", error);
                        document.getElementById("errorMessage").textContent = "ไม่สามารถโหลดข้อมูลสำหรับวันนี้ได้";
                        document.getElementById("errorMessage").style.display = "block";
                        document.getElementById("dashboard").innerHTML = "";
                    }
                });
            }
        }

        // ฟังก์ชันโหลดข้อมูลเครื่องบิน (ใช้ฟังก์ชันเดียวกับในไฟล์หลัก)
        async function fetchFlightData(selectedDate = null, silentMode = false, includeNextDay = true) {
            // ใช้ตัวแปรเพื่อติดตามว่าได้จบการจับเวลาไปแล้วหรือไม่
            window.fetchFlightDataTimerActive = true;
            console.time('fetchFlightData'); // เริ่มจับเวลาการทำงาน
            
            // รีเซ็ตข้อมูลทั้งหมดก่อนโหลดข้อมูลใหม่
            flightData = [];
            window.nextDayData = [];
            window.nextDayDate = null;
            
            // ตัวแปรสำหรับตรวจสอบว่ามีข้อมูลวันถัดไปหรือไม่
            let hasNextDayData = false;
            
            // รีเซ็ตสถานะการใช้ข้อมูลจากวันที่ใกล้เคียง
            isUsingNearbyDate = false;
            nearbyDateUsed = "";
            const sheetID = "1_M74Pe_4uul0fkcEea8AMxQIMcPznNZ9ttCqvbeQgBs";
            const aircraftSheetGID = "705816349";

            // สร้าง URL พร้อมพารามิเตอร์วันที่ (ถ้ามี)
            let aircraftURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&gid=${aircraftSheetGID}`;

            // เพิ่มพารามิเตอร์วันที่ถ้ามีการระบุ
            if (selectedDate) {
                aircraftURL += `&date=${selectedDate}`;
                console.log(`📅 กำลังโหลดข้อมูลสำหรับวันที่: ${selectedDate}`);
            }
            
            // คำนวณวันถัดไป - เปิดใช้งานเพื่อให้แสดงผลต่างของชั่วโมงบิน
            if (selectedDate && includeNextDay) {
                const currentDate = new Date(selectedDate);
                const nextDay = new Date(currentDate);
                nextDay.setDate(currentDate.getDate() + 1);
                
                // แปลงเป็นรูปแบบ YYYY-MM-DD
                const year = nextDay.getFullYear();
                const month = String(nextDay.getMonth() + 1).padStart(2, '0');
                const day = String(nextDay.getDate()).padStart(2, '0');
                window.nextDayDate = `${year}-${month}-${day}`;
                
                console.log(`📅 จะโหลดข้อมูลของวันถัดไป (${window.nextDayDate}) ด้วย`);
                
                // ตรวจสอบว่าวันถัดไปเป็นวันในอนาคตหรือไม่
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (nextDay > today) {
                    console.log(`⚠️ วันถัดไป (${window.nextDayDate}) เป็นวันในอนาคต อาจไม่มีข้อมูล`);
                }
            }

            // ไม่ใช้ระบบแคช โหลดข้อมูลใหม่ทุกครั้ง
            return await fetchFlightDataWithoutCache(selectedDate, silentMode, includeNextDay, aircraftURL, sheetID, aircraftSheetGID);
        }
        
        // ฟังก์ชันประมวลผลข้อมูลแถวสุดท้าย
        function processLastRowData(row, targetArray = flightData) {
            try {
                // ตรวจสอบว่ามีข้อมูลหรือไม่
                if (!row.c) {
                    console.error("❌ ข้อมูลแถวสุดท้ายไม่มีคอลัมน์");
                    return;
                }

                // ตรวจสอบว่ามีข้อมูล JSON ในคอลัมน์ B หรือไม่
                if (!row.c[1]?.v) {
                    console.error("❌ ข้อมูลแถวสุดท้ายไม่มีข้อมูล JSON ในคอลัมน์ B");
                    return;
                }

                console.log("📄 ข้อมูล JSON จากคอลัมน์ B:", row.c[1].v);

                // พยายามแปลงข้อมูล JSON จากคอลัมน์ B
                let jsonData;
                try {
                    jsonData = JSON.parse(row.c[1].v);
                    console.log("✅ แปลงข้อมูล JSON สำเร็จ");
                } catch (jsonError) {
                    console.error("❌ ไม่สามารถแปลงข้อมูล JSON ได้:", jsonError);
                    console.error("ข้อมูลที่พยายามแปลง:", row.c[1].v);
                    return;
                }

                // ตรวจสอบว่า JSON มีข้อมูลที่จำเป็นหรือไม่
                if (!jsonData || typeof jsonData !== 'object') {
                    console.error("❌ ข้อมูล JSON ไม่ถูกต้อง");
                    return;
                }

                console.log("📊 โครงสร้างข้อมูล JSON:", Object.keys(jsonData));

                // ตรวจสอบว่ามีข้อมูล Sheet1 หรือไม่
                if (jsonData.ข้อมูลSheet1 && Array.isArray(jsonData.ข้อมูลSheet1)) {
                    console.log("✅ พบข้อมูล Sheet1 จำนวน", jsonData.ข้อมูลSheet1.length, "รายการ");

                    // ประมวลผลข้อมูลจาก Sheet1
                    processSheet1Data(jsonData.ข้อมูลSheet1, targetArray);
                } else {
                    console.warn("⚠️ ไม่พบข้อมูล Sheet1 หรือข้อมูลไม่ใช่อาร์เรย์");
                }

                // ตรวจสอบว่ามีข้อมูล Sheet2 (เฮลิคอปเตอร์) หรือไม่
                if (jsonData.ข้อมูลSheet2 && Array.isArray(jsonData.ข้อมูลSheet2)) {
                    console.log("✅ พบข้อมูล Sheet2 (เฮลิคอปเตอร์) จำนวน", jsonData.ข้อมูลSheet2.length, "รายการ");

                    // ประมวลผลข้อมูลจาก Sheet2
                    processSheet2Data(jsonData.ข้อมูลSheet2, targetArray);
                } else {
                    console.warn("⚠️ ไม่พบข้อมูล Sheet2 หรือข้อมูลไม่ใช่อาร์เรย์");
                }
            } catch (error) {
                console.error("❌ เกิดข้อผิดพลาดในการประมวลผลข้อมูลแถวสุดท้าย:", error);
            }
        }
        
        // ฟังก์ชันประมวลผลข้อมูลจาก Sheet1
        function processSheet1Data(aircraftArray, targetArray = flightData) {
            if (!aircraftArray || !Array.isArray(aircraftArray) || aircraftArray.length === 0) {
                console.error("❌ ข้อมูล Sheet1 ไม่ถูกต้องหรือไม่มีข้อมูล");
                return;
            }

            console.log("🔄 เริ่มประมวลผลข้อมูลเครื่องบินจำนวน", aircraftArray.length, "รายการ");

            // วนลูปเพื่อเพิ่มข้อมูลเครื่องบินแต่ละลำ
            aircraftArray.forEach((aircraft, index) => {
                try {
                    // ตรวจสอบว่ามีข้อมูลพื้นฐานที่จำเป็นหรือไม่
                    if ((!aircraft["แบบเครื่องบิน"] && !aircraft["หมายเลข"]) &&
                        (!aircraft["แบบเครื่องบิน"] && !aircraft["เครื่องบิน"])) {
                        console.warn(`⚠️ ข้อมูลเครื่องบินลำดับที่ ${index + 1} ไม่มีแบบหรือหมายเลข`);
                        return; // ข้ามข้อมูลนี้
                    }

                    // ดึงข้อมูลจาก JSON ตามโครงสร้างที่กำหนด
                    const name = aircraft["แบบเครื่องบิน"] || "";
                    const aircraftNumber = aircraft["หมายเลข"] || aircraft["เครื่องบิน"] || "";
                    const status = aircraft["สถานะ"] === "พร้อมใช้งาน" ? "yes" : "no";
                    const remainingHours = aircraft["ชั่วโมงบินคงเหลือ"] || "";
                    const engineLH = aircraft["Engine LH"] || "";
                    const engineRH = aircraft["Engine RH"] || "";
                    const missionBase = aircraft["ฐานปฏิบัติการ"] || "";
                    const maintenanceManager = aircraft["ผู้จัดการซ่อมบำรุง"] || "";
                    const note = aircraft["หมายเหตุ"] || "";
                    const aCheck = aircraft["A-Check"] || "";
                    const aCheckDue = aircraft["A-Check Due"] || "";
                    const maintenanceType = aircraft["ประเภทการซ่อมบำรุง"] || "";

                    // แปลงค่าชั่วโมงบินคงเหลือให้เป็นตัวเลข
                    let rawHours100 = aircraft["ชั่วโมงบินคงเหลือครบซ่อม 100"] || "";
                    let rawHours150 = aircraft["ชั่วโมงบินคงเหลือครบซ่อม 150"] || "";
                    let rawHours300 = aircraft["ชั่วโมงบินคงเหลือครบซ่อม 300"] || "";

                    // ดึงข้อมูลพิกัด
                    let coordinates = [13.7563, 100.5018]; // พิกัดเริ่มต้น (กรุงเทพฯ)
                    
                    // ถ้ามีข้อมูลฐานปฏิบัติการ ให้ใช้พิกัดตามฐาน
                    if (missionBase) {
                        const province = extractProvince(missionBase);
                        if (provinceCoordinates[province]) {
                            coordinates = provinceCoordinates[province];
                        }
                    }

                    // เพิ่ม jitter ให้กับพิกัดเพื่อไม่ให้มาร์กเกอร์ทับกัน
                    coordinates = addJitter(coordinates);

                    // สร้างข้อมูลสำหรับการแสดงผล
                    let flight = {
                        id: aircraftNumber,
                        name: name,
                        aircraftNumber: aircraftNumber,
                        aircraftType: name, // ใช้แบบเครื่องบินเป็นประเภท
                        status: status,
                        remainingHours: remainingHours,
                        engineLH: engineLH,
                        engineRH: engineRH,
                        missionBase: missionBase,
                        maintenanceManager: maintenanceManager,
                        note: note,
                        aCheck: aCheck,
                        aCheckDue: aCheckDue,
                        maintenanceType: maintenanceType, // เก็บประเภทการซ่อมบำรุง (100, 150, 300)
                        latitude: coordinates[0],
                        longitude: coordinates[1],
                        type: "aircraft", // กำหนดประเภทเป็นเครื่องบิน
                        // เก็บข้อมูลดิบของชั่วโมงบินคงเหลือครบซ่อมทั้ง 3 ค่า
                        maintenanceHours: {
                            hours100: rawHours100,
                            hours150: rawHours150,
                            hours300: rawHours300
                        }
                    };

                    // เพิ่มข้อมูลเข้าไปในอาร์เรย์
                    targetArray.push(flight);

                    console.log(`✅ ประมวลผลข้อมูลเครื่องบินลำดับที่ ${index + 1} สำเร็จ: ${flight.name} (${flight.aircraftNumber})`);
                } catch (error) {
                    console.error(`❌ เกิดข้อผิดพลาดในการประมวลผลข้อมูลเครื่องบินลำดับที่ ${index + 1}:`, error);
                }
            });

            console.log(`✅ ประมวลผลข้อมูลเครื่องบินทั้งหมดสำเร็จ`);
        }

        // ฟังก์ชันประมวลผลข้อมูลจาก Sheet2 (เฮลิคอปเตอร์)
        function processSheet2Data(helicopterArray, targetArray = flightData) {
            if (!helicopterArray || !Array.isArray(helicopterArray) || helicopterArray.length === 0) {
                console.error("❌ ข้อมูล Sheet2 (เฮลิคอปเตอร์) ไม่ถูกต้องหรือไม่มีข้อมูล");
                return;
            }

            console.log("🔄 เริ่มประมวลผลข้อมูลเฮลิคอปเตอร์จำนวน", helicopterArray.length, "รายการ");

            // วนลูปเพื่อเพิ่มข้อมูลเฮลิคอปเตอร์แต่ละลำ
            helicopterArray.forEach((aircraft, index) => {
                try {
                    // ตรวจสอบว่ามีข้อมูลพื้นฐานที่จำเป็นหรือไม่
                    if ((!aircraft["แบบเครื่องบิน"] && !aircraft["หมายเลข"]) &&
                        (!aircraft["แบบเครื่องบิน"] && !aircraft["เครื่องบิน"])) {
                        console.warn(`⚠️ ข้อมูลเฮลิคอปเตอร์ลำดับที่ ${index + 1} ไม่มีแบบหรือหมายเลข`);
                        return; // ข้ามข้อมูลนี้
                    }

                    // ดึงข้อมูลจาก JSON ตามโครงสร้างที่กำหนด
                    const name = aircraft["แบบเครื่องบิน"] || "";
                    const aircraftNumber = aircraft["หมายเลข"] || aircraft["เครื่องบิน"] || "";
                    const status = aircraft["สถานะ"] === "พร้อมใช้งาน" ? "yes" : "no";
                    const remainingHours = aircraft["ชั่วโมงบินคงเหลือ"] || "";
                    const engineLH = aircraft["Engine LH"] || "";
                    const engineRH = aircraft["Engine RH"] || "";
                    const missionBase = aircraft["ฐานปฏิบัติการ"] || "";
                    const maintenanceManager = aircraft["ผู้จัดการซ่อมบำรุง"] || "";
                    const note = aircraft["หมายเหตุ"] || "";
                    const aCheck = aircraft["A-Check"] || "";
                    const aCheckDue = aircraft["A-Check Due"] || "";
                    const maintenanceType = aircraft["ประเภทการซ่อมบำรุง"] || "";

                    // แปลงค่าชั่วโมงบินคงเหลือให้เป็นตัวเลข
                    let rawHours100 = aircraft["ชั่วโมงบินคงเหลือครบซ่อม 100"] || "";
                    let rawHours150 = aircraft["ชั่วโมงบินคงเหลือครบซ่อม 150"] || "";
                    let rawHours300 = aircraft["ชั่วโมงบินคงเหลือครบซ่อม 300"] || "";

                    // ดึงข้อมูลพิกัด
                    let coordinates = [13.7563, 100.5018]; // พิกัดเริ่มต้น (กรุงเทพฯ)
                    
                    // ถ้ามีข้อมูลฐานปฏิบัติการ ให้ใช้พิกัดตามฐาน
                    if (missionBase) {
                        const province = extractProvince(missionBase);
                        if (provinceCoordinates[province]) {
                            coordinates = provinceCoordinates[province];
                        }
                    }

                    // เพิ่ม jitter ให้กับพิกัดเพื่อไม่ให้มาร์กเกอร์ทับกัน
                    coordinates = addJitter(coordinates);

                    // สร้างข้อมูลสำหรับการแสดงผล
                    let flight = {
                        id: aircraftNumber,
                        name: name,
                        aircraftNumber: aircraftNumber,
                        aircraftType: name, // ใช้แบบเครื่องบินเป็นประเภท
                        status: status,
                        remainingHours: remainingHours,
                        engineLH: engineLH,
                        engineRH: engineRH,
                        missionBase: missionBase,
                        maintenanceManager: maintenanceManager,
                        note: note,
                        aCheck: aCheck,
                        aCheckDue: aCheckDue,
                        maintenanceType: maintenanceType, // เก็บประเภทการซ่อมบำรุง (100, 150, 300)
                        latitude: coordinates[0],
                        longitude: coordinates[1],
                        type: "helicopter", // กำหนดประเภทเป็นเฮลิคอปเตอร์
                        // เก็บข้อมูลดิบของชั่วโมงบินคงเหลือครบซ่อมทั้ง 3 ค่า
                        maintenanceHours: {
                            hours100: rawHours100,
                            hours150: rawHours150,
                            hours300: rawHours300
                        }
                    };

                    // เพิ่มข้อมูลเข้าไปในอาร์เรย์
                    targetArray.push(flight);

                    console.log(`✅ ประมวลผลข้อมูลเฮลิคอปเตอร์ลำดับที่ ${index + 1} สำเร็จ: ${flight.name} (${flight.aircraftNumber})`);
                } catch (error) {
                    console.error(`❌ เกิดข้อผิดพลาดในการประมวลผลข้อมูลเฮลิคอปเตอร์ลำดับที่ ${index + 1}:`, error);
                }
            });

            console.log(`✅ ประมวลผลข้อมูลเฮลิคอปเตอร์ทั้งหมดสำเร็จ`);
        }
        
        // ฟังก์ชันเพิ่ม jitter ให้กับพิกัดเพื่อไม่ให้มาร์กเกอร์ทับกัน
        function addJitter(coordinates) {
            // ตรวจสอบรูปแบบพารามิเตอร์ที่รับเข้ามา
            let lat, lng;
            
            if (Array.isArray(coordinates) && coordinates.length === 2) {
                // กรณีรับเป็น array [lat, lng]
                [lat, lng] = coordinates;
            } else {
                console.warn("พิกัดไม่ถูกต้อง ไม่สามารถเพิ่ม jitter ได้");
                return coordinates || [0, 0];
            }
            
            try {
                // ตรวจสอบว่าพิกัดเป็นตัวเลขหรือไม่
                lat = parseFloat(lat);
                lng = parseFloat(lng);

                if (isNaN(lat) || isNaN(lng)) {
                    console.warn("พิกัดไม่ใช่ตัวเลข ไม่สามารถเพิ่ม jitter ได้");
                    return coordinates;
                }

                // สร้างคีย์สำหรับตำแหน่งนี้ (ปัดเศษให้เหลือ 4 ตำแหน่ง)
                const key = `${lat.toFixed(4)},${lng.toFixed(4)}`;

                // ตรวจสอบว่ามีมาร์กเกอร์ในตำแหน่งนี้กี่ตัวแล้ว
                if (!positionCounts[key]) {
                    positionCounts[key] = 0;
                }

                // เพิ่มจำนวนมาร์กเกอร์ในตำแหน่งนี้
                positionCounts[key]++;
                const count = positionCounts[key];

                // กำหนดระยะห่างระหว่างเครื่องบิน
                const offset = 0.0005 * Math.min(count, 5); // จำกัดระยะห่างสูงสุด

                // ถ้ามีมาร์กเกอร์ในตำแหน่งนี้มากกว่า 1 ตัว ให้เพิ่ม jitter
                if (count > 1) {
                    // คำนวณมุมสำหรับการกระจายมาร์กเกอร์เป็นวงกลม
                    const angle = (count - 2) * (Math.PI / 4); // แบ่งเป็น 8 ส่วนรอบวงกลม

                    // คำนวณพิกัดใหม่
                    const jitteredLat = lat + offset * Math.cos(angle);
                    const jitteredLng = lng + offset * Math.sin(angle);

                    return [jitteredLat, jitteredLng];
                }

                // ถ้ามีมาร์กเกอร์ในตำแหน่งนี้เพียงตัวเดียว ให้ใช้พิกัดเดิม
                return [lat, lng];
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการเพิ่ม jitter:", error);
                return coordinates;
            }
        }
        
        // ฟังก์ชันสกัดชื่อจังหวัดจากข้อความ
        function extractProvince(text) {
            for (let province in provinceCoordinates) {
                if (text.includes(province)) {
                    return province;
                }
            }
            return "นครสวรรค์"; // ค่าเริ่มต้น
        }
        
        // ฟังก์ชันโหลดข้อมูลโดยไม่ใช้ระบบแคช
        async function fetchFlightDataWithoutCache(selectedDate, silentMode, includeNextDay, aircraftURL, sheetID, aircraftSheetGID) {
            console.log("📡 กำลังโหลดข้อมูลใหม่จาก Google Sheets โดยไม่ใช้ระบบแคช...");
            
            try {
                // ใช้ fetch options เพื่อไม่ให้ใช้ cache ของ browser
                const fetchOptions = {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                };
                
                // โหลดข้อมูลจาก Google Sheets
                const response = await fetch(aircraftURL, fetchOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                
                // ตรวจสอบว่าข้อมูลที่ได้รับมีความยาวเพียงพอ
                if (!text || text.length < 50) {
                    throw new Error("ข้อมูลที่ได้รับจาก Google Sheets ไม่ถูกต้อง");
                }
                
                try {
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    
                    // ตรวจสอบว่า JSON มีโครงสร้างที่ถูกต้อง
                    if (!json || !json.table || !json.table.rows) {
                        throw new Error("โครงสร้าง JSON ไม่ถูกต้อง");
                    }
                    
                    // ตรวจสอบว่ามีข้อมูลหรือไม่
                    if (json && json.table && json.table.rows && json.table.rows.length > 0) {
                        console.log(`📊 ดึงข้อมูลจาก Google Sheets สำเร็จ จำนวน ${json.table.rows.length} แถว`);
                        
                        // ถ้ามีการระบุวันที่ ให้หาแถวที่มีวันที่ตรงกับที่เลือก
                        if (selectedDate) {
                            console.log(`🔍 กำลังค้นหาข้อมูลสำหรับวันที่: ${selectedDate}`);
                            
                            // วนลูปตรวจสอบทุกแถว
                            let foundRow = null;
                            for (let i = 0; i < json.table.rows.length; i++) {
                                const row = json.table.rows[i];
                                
                                // ตรวจสอบว่ามีข้อมูลในคอลัมน์ A (วันที่) หรือไม่
                                if (row.c && row.c[0] && row.c[0].v) {
                                    // ดึงค่าวันที่จากคอลัมน์ A
                                    let rowDate = row.c[0].v;
                                    let originalRowDate = rowDate; // เก็บค่าดั้งเดิมไว้เพื่อแสดงในการเปรียบเทียบ
                                    
                                    // ตรวจสอบรูปแบบวันที่และแปลงให้เป็นรูปแบบเดียวกัน
                                    if (rowDate instanceof Date) {
                                        rowDate = rowDate.toISOString().split('T')[0];
                                        console.log(`  - แปลงจาก Date object เป็น: ${rowDate}`);
                                    } else if (typeof rowDate === 'string' && rowDate.includes('Date(')) {
                                        // ถ้าเป็นสตริงในรูปแบบ "Date(2025,3,5,0,56,41)"
                                        console.log(`  - พบค่าเป็นสตริงในรูปแบบ Date(): ${rowDate}`);
                                        
                                        try {
                                            // แยกส่วนประกอบของวันที่
                                            const dateStr = rowDate.replace('Date(', '').replace(')', '');
                                            const dateParts = dateStr.split(',').map(part => part.trim());
                                            
                                            if (dateParts.length >= 3) {
                                                // สร้าง Date object จากส่วนประกอบ
                                                const year = parseInt(dateParts[0]);
                                                const month = parseInt(dateParts[1]); // เดือนใน JavaScript เริ่มจาก 0
                                                const day = parseInt(dateParts[2]);
                                                
                                                const dateObj = new Date(year, month, day);
                                                
                                                // แปลงเป็นรูปแบบ YYYY-MM-DD ด้วยการสร้างสตริงเอง
                                                // เนื่องจาก toISOString() อาจมีปัญหาเรื่อง timezone
                                                const isoYear = dateObj.getFullYear();
                                                const isoMonth = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                                                const isoDay = dateObj.getDate().toString().padStart(2, '0');
                                                rowDate = `${isoYear}-${isoMonth}-${isoDay}`;
                                                
                                                console.log(`  - วันที่ดิบ: ${year}-${month}-${day}, แปลงเป็น: ${rowDate}`);
                                                console.log(`  - แปลงจาก Date() string เป็น: ${rowDate}`);
                                            }
                                        } catch (e) {
                                            console.log(`  - ไม่สามารถแปลง Date() string ได้: ${e.message}`);
                                        }
                                    } else if (typeof rowDate === 'string' && rowDate.includes('/')) {
                                        // แปลงจากรูปแบบ DD/MM/YYYY เป็น YYYY-MM-DD
                                        const parts = rowDate.split('/');
                                        if (parts.length === 3) {
                                            rowDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                                            console.log(`  - แปลงจาก DD/MM/YYYY เป็น: ${rowDate}`);
                                        }
                                    }
                                    
                                    // เปรียบเทียบวันที่
                                    console.log(`  - เปรียบเทียบ: '${rowDate}' กับ '${selectedDate}'`);
                                    if (rowDate === selectedDate) {
                                        console.log(`✅ พบข้อมูลสำหรับวันที่ ${selectedDate} ที่แถวที่ ${i + 1}`);
                                        foundRow = row;
                                        break;
                                    }
                                    
                                    // ตรวจสอบแบบแปลงเป็น Date object และเปรียบเทียบ
                                    try {
                                        // แปลงวันที่ทั้งสองเป็น Date object
                                        const rowDateObj = new Date(rowDate);
                                        const selectedDateObj = new Date(selectedDate);
                                        
                                        // ตรวจสอบว่าเป็น Date object ที่ถูกต้องหรือไม่
                                        if (!isNaN(rowDateObj) && !isNaN(selectedDateObj)) {
                                            console.log(`  - เปรียบเทียบแบบ Date object: ${rowDateObj.toISOString().split('T')[0]} กับ ${selectedDateObj.toISOString().split('T')[0]}`);
                                            console.log(`  - วัน: ${rowDateObj.getDate()} vs ${selectedDateObj.getDate()}`);
                                            console.log(`  - เดือน: ${rowDateObj.getMonth()} vs ${selectedDateObj.getMonth()}`);
                                            console.log(`  - ปี: ${rowDateObj.getFullYear()} vs ${selectedDateObj.getFullYear()}`);
                                            
                                            // เปรียบเทียบเฉพาะวัน เดือน ปี
                                            if (rowDateObj.getDate() === selectedDateObj.getDate() &&
                                                rowDateObj.getMonth() === selectedDateObj.getMonth() &&
                                                rowDateObj.getFullYear() === selectedDateObj.getFullYear()) {
                                                console.log(`✅ พบข้อมูลสำหรับวันที่ ${selectedDate} ที่แถวที่ ${i + 1} (เปรียบเทียบแบบ Date object)`);
                                                foundRow = row;
                                                break;
                                            }
                                        }
                                    } catch (e) {
                                        console.log(`⚠️ ไม่สามารถเปรียบเทียบวันที่แบบ Date object ได้: ${e.message}`);
                                    }
                                }
                            }
                            
                            // ถ้าพบแถวที่มีวันที่ตรงกับที่เลือก
                            if (foundRow) {
                                // รีเซ็ตตัวนับตำแหน่ง
                                for (let key in positionCounts) {
                                    delete positionCounts[key];
                                }
                                
                                // ประมวลผลข้อมูลแถวที่พบ
                                processLastRowData(foundRow);
                            } else {
                                // ตรวจสอบว่าเป็นวันที่ในอนาคตหรือไม่
                                const selectedDateObj = new Date(selectedDate);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0); // รีเซ็ตเวลาเป็น 00:00:00
                                
                                if (selectedDateObj > today) {
                                    console.warn(`⚠️ ไม่พบข้อมูลสำหรับวันที่ ${selectedDate} (วันที่ในอนาคต)`);
                                    throw new Error(`ไม่พบข้อมูลสำหรับวันที่ ${selectedDate} (วันที่ในอนาคต)`);
                                } else {
                                    console.warn(`⚠️ ไม่พบข้อมูลสำหรับวันที่ ${selectedDate}`);
                                    throw new Error(`ไม่พบข้อมูลสำหรับวันที่ ${selectedDate}`);
                                }
                            }
                        } else {
                            // ถ้าไม่มีการระบุวันที่ ให้ใช้แถวสุดท้าย (ข้อมูลล่าสุด)
                            const lastRow = json.table.rows[json.table.rows.length - 1];
                            console.log(`📊 ใช้ข้อมูลล่าสุดจากแถวสุดท้าย`);
                            
                            // รีเซ็ตตัวนับตำแหน่ง
                            for (let key in positionCounts) {
                                delete positionCounts[key];
                            }
                            
                            // ประมวลผลข้อมูลแถวสุดท้าย
                            processLastRowData(lastRow);
                        }
                    }
                    
                    console.log("✅ ข้อมูลอัปเดตแล้ว:", flightData.length, "รายการ");
                    
                    // ถ้าต้องการข้อมูลวันถัดไป ให้โหลดข้อมูลวันถัดไป
                    let hasNextDayData = false;
                    if (includeNextDay && window.nextDayDate) {
                        try {
                            console.log(`🔄 กำลังโหลดข้อมูลวันถัดไป ${window.nextDayDate}...`);
                            // สร้าง URL สำหรับวันถัดไป
                            const nextDayURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&gid=${aircraftSheetGID}&date=${window.nextDayDate}`;
                            
                            const nextDayResponse = await fetch(nextDayURL, fetchOptions);
                            
                            if (nextDayResponse.ok) {
                                const nextDayText = await nextDayResponse.text();
                                
                                // ตรวจสอบว่าข้อมูลที่ได้รับมีความยาวเพียงพอ
                                if (nextDayText && nextDayText.length > 50) {
                                    try {
                                        const nextDayJson = JSON.parse(nextDayText.substring(47, nextDayText.length - 2));
                                        
                                        // ตรวจสอบว่า JSON มีโครงสร้างที่ถูกต้อง
                                        if (nextDayJson && nextDayJson.table && nextDayJson.table.rows && nextDayJson.table.rows.length > 0) {
                                            // ใช้แถวสุดท้าย (ข้อมูลล่าสุด)
                                            const lastRow = nextDayJson.table.rows[nextDayJson.table.rows.length - 1];
                                            
                                            // ประมวลผลข้อมูลแถวสุดท้าย
                                            window.nextDayData = [];
                                            processLastRowData(lastRow, window.nextDayData);
                                            
                                            console.log(`✅ โหลดข้อมูลของวันถัดไป (${window.nextDayDate}) สำเร็จ: ${window.nextDayData.length} รายการ`);
                                            hasNextDayData = true;
                                        }
                                    } catch (error) {
                                        console.error(`❌ เกิดข้อผิดพลาดในการประมวลผลข้อมูลวันถัดไป:`, error);
                                    }
                                }
                            }
                            
                            if (!hasNextDayData) {
                                console.warn(`⚠️ ไม่พบข้อมูลสำหรับวันถัดไป ${window.nextDayDate}`);
                            }
                        } catch (error) {
                            console.error(`❌ เกิดข้อผิดพลาดในการโหลดข้อมูลวันถัดไป:`, error);
                        }
                    }
                    
                    // ถ้าไม่ใช่โหมดเงียบ ให้อัปเดต UI
                    if (!silentMode) {
                        renderDashboard();
                    }
                } catch (error) {
                    console.error("❌ เกิดข้อผิดพลาดในการประมวลผลข้อมูล JSON:", error);
                    throw error;
                }
            } catch (error) {
                console.error("❌ โหลดข้อมูลไม่สำเร็จ:", error);
                throw error;
            } finally {
                // จบการจับเวลาถ้ายังไม่ได้จบไปแล้ว
                if (window.fetchFlightDataTimerActive) {
                    console.timeEnd('fetchFlightData'); // จบการจับเวลา
                    window.fetchFlightDataTimerActive = false;
                }
            }

            // ตรวจสอบว่ามีข้อมูลใน localStorage หรือไม่
            let cachedData = null;
            let cachedTimestamp = null;
            let nextDayCachedData = null;
            let nextDayCachedTimestamp = null;
            const currentTime = new Date().getTime();
            
            try {
                // ไม่ใช้ระบบแคช จึงไม่ต้องดึงข้อมูลจาก localStorage
            } catch (e) {
                console.error("❌ เกิดข้อผิดพลาดในการอ่านข้อมูลจาก localStorage:", e);
            }

            // ถ้ามีข้อมูลใน cache และยังไม่หมดอายุ ให้ใช้ข้อมูลจาก cache
            if (cachedData && cachedTimestamp && (currentTime - parseInt(cachedTimestamp) < CACHE_EXPIRATION)) {
                console.log(`📋 ใช้ข้อมูลจาก cache สำหรับ ${selectedDate || 'วันนี้'}...`);
                
                try {
                    // โหลดข้อมูลจาก cache
                    const parsedData = JSON.parse(cachedData);
                    
                    // ตรวจสอบว่าข้อมูลที่ได้จาก cache เป็นอาร์เรย์หรือไม่
                    if (Array.isArray(parsedData)) {
                        flightData = parsedData;
                        
                        // โหลดข้อมูลวันถัดไปจาก cache ถ้ามี
                        hasNextDayData = false;
                        if (window.nextDayDate && nextDayCachedData && nextDayCachedTimestamp && 
                            (currentTime - parseInt(nextDayCachedTimestamp) < CACHE_EXPIRATION)) {
                            try {
                                const parsedNextDayData = JSON.parse(nextDayCachedData);
                                if (Array.isArray(parsedNextDayData)) {
                                    window.nextDayData = parsedNextDayData;
                                    console.log(`📋 ใช้ข้อมูลจาก cache สำหรับวันถัดไป ${window.nextDayDate}...`);
                                    hasNextDayData = window.nextDayData && window.nextDayData.length > 0;
                                    
                                    // ถ้าเป็นโหมดเงียบ ไม่ต้องอัปเดต UI
                                    if (silentMode) {
                                        console.log(`🔕 โหมดเงียบ: ข้อมูลสำหรับวันที่ ${selectedDate || 'วันนี้'} และวันถัดไปมีอยู่ใน cache แล้ว`);
                                        // จบการจับเวลาถ้ายังไม่ได้จบไปแล้ว
                                        if (window.fetchFlightDataTimerActive) {
                                            console.timeEnd('fetchFlightData'); // จบการจับเวลา
                                            window.fetchFlightDataTimerActive = false;
                                        }
                                        return;
                                    }
                                    
                                    if (hasNextDayData) {
                                        console.log("✅ โหลดข้อมูลจาก cache สำเร็จ:", flightData.length, "รายการ และข้อมูลวันถัดไป:", window.nextDayData.length, "รายการ");
                                        // จบการจับเวลาถ้ายังไม่ได้จบไปแล้ว
                                        if (window.fetchFlightDataTimerActive) {
                                            console.timeEnd('fetchFlightData'); // จบการจับเวลา
                                            window.fetchFlightDataTimerActive = false;
                                        }
                                        return;
                                    }
                                }
                            } catch (e) {
                                console.error("❌ เกิดข้อผิดพลาดในการแปลงข้อมูลวันถัดไปจาก cache:", e);
                                // ลบข้อมูล cache ที่มีปัญหา
                                localStorage.removeItem(nextDayCacheKey);
                                localStorage.removeItem(nextDayTimestampKey);
                            }
                        }
                    } else {
                        console.warn("⚠️ ข้อมูลใน cache ไม่ใช่อาร์เรย์ จะโหลดข้อมูลใหม่แทน");
                        // ลบข้อมูล cache ที่ไม่ถูกต้อง
                        localStorage.removeItem(cacheKey);
                        localStorage.removeItem(timestampKey);
                        flightData = []; // รีเซ็ตข้อมูล
                    }
                } catch (e) {
                    console.error("❌ เกิดข้อผิดพลาดในการแปลงข้อมูลจาก cache:", e);
                    // ลบข้อมูล cache ที่มีปัญหา
                    localStorage.removeItem(cacheKey);
                    localStorage.removeItem(timestampKey);
                    flightData = []; // รีเซ็ตข้อมูล
                }
                
                // ถ้าต้องการข้อมูลวันถัดไปแต่ไม่มีใน cache หรือมีแต่ว่าง ให้พยายามโหลดจาก server
                if (includeNextDay && window.nextDayDate && !hasNextDayData) {
                    console.log(`⚠️ ไม่พบข้อมูลวันถัดไป ${window.nextDayDate} ใน cache หรือข้อมูลว่าง จะพยายามโหลดจาก server`);
                    
                    try {
                        console.log(`🔄 กำลังพยายามโหลดข้อมูลวันถัดไป ${window.nextDayDate} โดยตรง...`);
                                // สร้าง URL สำหรับวันถัดไป
                        let nextDayURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&gid=${aircraftSheetGID}&date=${window.nextDayDate}`;
                        
                        // โหลดข้อมูลวันถัดไป
                        const nextDayResponse = await fetch(nextDayURL);
                        const nextDayText = await nextDayResponse.text();
                        const nextDayJson = JSON.parse(nextDayText.substring(47, nextDayText.length - 2));
                        
                        if (nextDayJson && nextDayJson.table && nextDayJson.table.rows && nextDayJson.table.rows.length > 0) {
                            // วนลูปตรวจสอบทุกแถว
                            for (let i = 0; i < nextDayJson.table.rows.length; i++) {
                                const row = nextDayJson.table.rows[i];
                                
                                // ตรวจสอบว่ามีข้อมูลในคอลัมน์ A (วันที่) หรือไม่
                                if (row.c && row.c[0] && row.c[0].v) {
                                    // ดึงค่าวันที่จากคอลัมน์ A
                                    let rowDate = formatDate(row.c[0].v);
                                    
                                    // ตรวจสอบว่าวันที่ตรงกับวันถัดไปหรือไม่
                                    if (rowDate === window.nextDayDate) {
                                        // ประมวลผลข้อมูลของวันถัดไป
                                        window.nextDayData = [];
                                        processRowData(row, window.nextDayData);
                                        console.log(`✅ โหลดข้อมูลของวันถัดไป (${window.nextDayDate}) สำเร็จ: ${window.nextDayData.length} รายการ`);
                                        
                                        // บันทึกข้อมูลวันถัดไปลงใน cache
                                        localStorage.setItem(nextDayCacheKey, JSON.stringify(window.nextDayData));
                                        localStorage.setItem(nextDayTimestampKey, currentTime.toString());
                                        hasNextDayData = true;
                                        break;
                                    }
                                }
                            }
                            
                            if (!hasNextDayData) {
                                console.warn(`⚠️ ไม่พบข้อมูลสำหรับวันถัดไป ${window.nextDayDate} ในการโหลดโดยตรง`);
                            }
                        } else {
                            console.warn(`⚠️ ไม่พบข้อมูลสำหรับวันถัดไป ${window.nextDayDate} ในการโหลดโดยตรง`);
                        }
                    } catch (error) {
                        console.error(`❌ เกิดข้อผิดพลาดในการโหลดข้อมูลวันถัดไป ${window.nextDayDate}:`, error);
                    }
                }
                
                // ถ้าเป็นโหมดเงียบ (silent mode) ให้เก็บข้อมูลไว้ใน cache เท่านั้น ไม่ต้องอัปเดต UI
                if (silentMode) {
                    console.log(`🔕 โหมดเงียบ: ข้อมูลสำหรับวันที่ ${selectedDate || 'วันนี้'} มีอยู่ใน cache แล้ว`);
                    return;
                }
                
                console.log("✅ โหลดข้อมูลจาก cache สำเร็จ:", flightData.length, "รายการ");
                if (hasNextDayData) {
                    console.log("✅ และข้อมูลวันถัดไป:", window.nextDayData.length, "รายการ");
                }
                
                return;
                
            }

            try {
                console.log("📡 กำลังโหลดข้อมูลจาก Google Sheets...");
                
                // ใช้ fetch options เพื่อไม่ให้ใช้ cache ของ browser
                const fetchOptions = {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                };
                
                const response = await fetch(aircraftURL, fetchOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                
                // ตรวจสอบว่าข้อมูลที่ได้รับมีความยาวเพียงพอ
                if (!text || text.length < 50) {
                    throw new Error("ข้อมูลที่ได้รับจาก Google Sheets ไม่ถูกต้อง");
                }
                
                const json = JSON.parse(text.substring(47, text.length - 2));
                
                // ตรวจสอบว่า JSON มีโครงสร้างที่ถูกต้อง
                if (!json || !json.table || !json.table.rows) {
                    throw new Error("โครงสร้าง JSON ไม่ถูกต้อง");
                }

                // รีเซ็ตข้อมูลอีกครั้งก่อนโหลดจาก server
                flightData = [];
                window.nextDayData = [];

                // ตรวจสอบว่ามีข้อมูลหรือไม่
                if (json && json.table && json.table.rows && json.table.rows.length > 0) {
                    console.log(`📊 ดึงข้อมูลจาก Google Sheets สำเร็จ จำนวน ${json.table.rows.length} แถว`);

                    // ถ้ามีการระบุวันที่ ให้หาแถวที่มีวันที่ตรงกับที่เลือก
                    if (selectedDate) {
                        console.log(`🔍 กำลังค้นหาข้อมูลสำหรับวันที่: ${selectedDate}`);

                        // วนลูปตรวจสอบทุกแถว
                        let foundRow = null;
                        for (let i = 0; i < json.table.rows.length; i++) {
                            const row = json.table.rows[i];

                            // ตรวจสอบว่ามีข้อมูลในคอลัมน์ A (วันที่) หรือไม่
                            if (row.c && row.c[0] && row.c[0].v) {
                                // ดึงค่าวันที่จากคอลัมน์ A
                                let rowDate = row.c[0].v;
                                
                                // แปลงวันที่ให้เป็นรูปแบบ YYYY-MM-DD
                                rowDate = formatDate(rowDate);

                                // ตรวจสอบว่าวันที่ตรงกันหรือไม่
                                if (rowDate === selectedDate) {
                                    foundRow = row;
                                    break;
                                }
                            }
                        }

                        // ถ้าพบแถวที่มีวันที่ตรงกับที่เลือก
                        if (foundRow) {
                            // ประมวลผลข้อมูลแถวที่พบ
                            processRowData(foundRow);
                            
                            // ถ้าต้องการข้อมูลวันถัดไปด้วย
                            if (window.nextDayDate && includeNextDay) {
                                // ค้นหาข้อมูลของวันถัดไป
                                let nextDayFoundRow = null;
                                for (let i = 0; i < json.table.rows.length; i++) {
                                    const row = json.table.rows[i];
                                    if (row.c && row.c[0] && row.c[0].v) {
                                        let rowDate = formatDate(row.c[0].v);
                                        if (rowDate === window.nextDayDate) {
                                            nextDayFoundRow = row;
                                            break;
                                        }
                                    }
                                }
                                
                                if (nextDayFoundRow) {
                                    // ประมวลผลข้อมูลของวันถัดไป
                                    window.nextDayData = [];
                                    processRowData(nextDayFoundRow, window.nextDayData);
                                    console.log(`✅ โหลดข้อมูลของวันถัดไป (${window.nextDayDate}) สำเร็จ: ${window.nextDayData.length} รายการ`);
                                    
                                    // บันทึกข้อมูลวันถัดไปลงใน cache
                                    const nextDayCacheKey = `flightDataCache_${window.nextDayDate}`;
                                    const nextDayTimestampKey = `flightDataTimestamp_${window.nextDayDate}`;
                                    localStorage.setItem(nextDayCacheKey, JSON.stringify(window.nextDayData));
                                    localStorage.setItem(nextDayTimestampKey, currentTime.toString());
                                } else {
                                    console.warn(`⚠️ ไม่พบข้อมูลสำหรับวันถัดไป ${window.nextDayDate} ในข้อมูลที่โหลดมา`);
                                    
                                    // พยายามโหลดข้อมูลวันถัดไปโดยตรง
                                    try {
                                        console.log(`🔄 กำลังพยายามโหลดข้อมูลวันถัดไป ${window.nextDayDate} โดยตรง...`);
                                        
                                        // สร้าง URL สำหรับวันถัดไป
                                        let nextDayURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&gid=${aircraftSheetGID}&date=${window.nextDayDate}`;
                                        
                                        // โหลดข้อมูลวันถัดไป
                                        const nextDayResponse = await fetch(nextDayURL);
                                        const nextDayText = await nextDayResponse.text();
                                        const nextDayJson = JSON.parse(nextDayText.substring(47, nextDayText.length - 2));
                                        
                                        if (nextDayJson && nextDayJson.table && nextDayJson.table.rows && nextDayJson.table.rows.length > 0) {
                                            // วนลูปตรวจสอบทุกแถว
                                            for (let i = 0; i < nextDayJson.table.rows.length; i++) {
                                                const row = nextDayJson.table.rows[i];
                                                
                                                // ตรวจสอบว่ามีข้อมูลในคอลัมน์ A (วันที่) หรือไม่
                                                if (row.c && row.c[0] && row.c[0].v) {
                                                    // ดึงค่าวันที่จากคอลัมน์ A
                                                    let rowDate = formatDate(row.c[0].v);
                                                    
                                                    // ตรวจสอบว่าวันที่ตรงกับวันถัดไปหรือไม่
                                                    if (rowDate === window.nextDayDate) {
                                                        // ประมวลผลข้อมูลของวันถัดไป
                                                        window.nextDayData = [];
                                                        processRowData(row, window.nextDayData);
                                                        console.log(`✅ โหลดข้อมูลของวันถัดไป (${window.nextDayDate}) สำเร็จ: ${window.nextDayData.length} รายการ`);
                                                        
                                                        // บันทึกข้อมูลวันถัดไปลงใน cache
                                                        localStorage.setItem(nextDayCacheKey, JSON.stringify(window.nextDayData));
                                                        localStorage.setItem(nextDayTimestampKey, currentTime.toString());
                                                        break;
                                                    }
                                                }
                                            }
                                            
                                            if (window.nextDayData.length === 0) {
                                                console.warn(`⚠️ ไม่พบข้อมูลสำหรับวันถัดไป ${window.nextDayDate} ในการโหลดโดยตรง`);
                                            }
                                        } else {
                                            console.warn(`⚠️ ไม่พบข้อมูลสำหรับวันถัดไป ${window.nextDayDate} ในการโหลดโดยตรง`);
                                        }
                                    } catch (error) {
                                        console.error(`❌ เกิดข้อผิดพลาดในการโหลดข้อมูลวันถัดไป ${window.nextDayDate}:`, error);
                                    }
                                }
                            }
                        } else {
                            console.warn(`⚠️ ไม่พบข้อมูลสำหรับวันที่ ${selectedDate}`);
                            
                            // แสดงรายการวันที่ที่มีข้อมูล (เพื่อการดีบัก)
                            const availableDates = [];
                            const dateRows = []; // เก็บคู่ของวันที่และแถวข้อมูล
                            
                            for (let i = 0; i < json.table.rows.length; i++) {
                                const row = json.table.rows[i];
                                if (row.c && row.c[0] && row.c[0].v) {
                                    let rowDate = formatDate(row.c[0].v);
                                    if (rowDate) {
                                        availableDates.push(rowDate);
                                        dateRows.push({ date: rowDate, row: row });
                                        
                                        // ตรวจสอบอีกครั้งว่าวันที่ตรงกับที่เลือกหรือไม่
                                        if (rowDate === selectedDate) {
                                            console.log(`🔍 พบข้อมูลสำหรับวันที่ ${selectedDate} ในการตรวจสอบรอบที่ 2`);
                                            foundRow = row;
                                        }
                                    }
                                }
                            }
                            
                            // เรียงลำดับวันที่
                            availableDates.sort();
                            dateRows.sort((a, b) => a.date.localeCompare(b.date));
                            
                            if (availableDates.length > 0) {
                                console.log(`📅 วันที่ที่มีข้อมูล: ${availableDates.join(', ')}`);
                            }
                            
                            // ถ้าพบข้อมูลในการตรวจสอบรอบที่ 2
                            if (foundRow) {
                                console.log(`✅ พบข้อมูลสำหรับวันที่ ${selectedDate} ในการตรวจสอบรอบที่ 2 - ประมวลผลข้อมูล`);
                                processRowData(foundRow);
                                return;
                            }
                            
                            // ไม่ใช้ข้อมูลจากวันที่ใกล้เคียง - ให้แสดงข้อความว่าไม่พบข้อมูล
                            
                            // ถ้าไม่พบข้อมูลสำหรับวันที่ที่เลือก
                            if (silentMode) {
                                console.warn(`🔕 โหมดเงียบ: ไม่พบข้อมูลสำหรับวันที่ ${selectedDate}`);
                                return;
                            } else {
                                // ดึงรายการวันที่ที่มีข้อมูลจาก localStorage เพื่อแสดงให้ผู้ใช้
                                const allDatesKey = 'allCachedDates';
                                try {
                                    const cachedDates = localStorage.getItem(allDatesKey);
                                    if (cachedDates) {
                                        const availableDates = JSON.parse(cachedDates);
                                        availableDates.sort();
                                        console.log(`� วันที่ที่มีข้อมูลใน cache: ${availableDates.join(', ')}`);
                                    }
                                } catch (e) {
                                    console.error("ไม่สามารถดึงรายการวันที่ได้:", e);
                                }
                                
                                // ไม่ใช้ข้อมูลจากวันที่ใกล้เคียงหรือวันล่าสุด - ให้แสดงข้อความว่าไม่พบข้อมูล
                                
                                // ถ้าไม่สามารถใช้ข้อมูลล่าสุดได้ ให้แจ้งเตือนว่าไม่พบข้อมูล
                                throw new Error(`ไม่พบข้อมูลสำหรับวันที่ ${selectedDate}`);
                            }
                        }
                    } else {
                        // ถ้าไม่มีการระบุวันที่ ให้ใช้แถวสุดท้าย (ข้อมูลล่าสุด)
                        const lastRow = json.table.rows[json.table.rows.length - 1];
                        console.log(`📊 ใช้ข้อมูลล่าสุดจากแถวสุดท้าย`);
                        processRowData(lastRow);
                    }
                }

                // ไม่บันทึกข้อมูลลงใน localStorage เนื่องจากไม่ใช้ระบบแคช

                console.log("✅ ข้อมูลอัปเดตแล้ว:", flightData.length, "รายการ");
                
                // ถ้าเป็นโหมดเงียบ ไม่ต้องอัปเดต UI
                if (silentMode) {
                    console.log(`🔕 โหมดเงียบ: บันทึกข้อมูลสำหรับวันที่ ${selectedDate || 'วันนี้'} ลงใน cache เรียบร้อยแล้ว`);
                    // จบการจับเวลาถ้ายังไม่ได้จบไปแล้ว
                    if (window.fetchFlightDataTimerActive) {
                        console.timeEnd('fetchFlightData'); // จบการจับเวลา
                        window.fetchFlightDataTimerActive = false;
                    }
                }
            } catch (error) {
                console.error("❌ โหลดข้อมูลไม่สำเร็จ:", error);
                
                // ถ้าเป็นโหมดเงียบ ไม่ต้องโยนข้อผิดพลาด
                if (silentMode) {
                    console.warn(`🔕 โหมดเงียบ: เกิดข้อผิดพลาดในการโหลดข้อมูลสำหรับวันที่ ${selectedDate || 'วันนี้'} แต่ไม่มีผลกระทบต่อ UI`);
                    return;
                }
                
                throw error;
            }
        }

        // ฟังก์ชันประมวลผลข้อมูลแถว
        function processRowData(row, targetArray = null) {
            // ถ้าไม่ได้ระบุ targetArray ให้ใช้ flightData
            const dataArray = targetArray || flightData;
            try {
                // ตรวจสอบว่ามีข้อมูลหรือไม่
                if (!row.c) {
                    console.error("❌ ข้อมูลแถวไม่มีคอลัมน์");
                    return;
                }

                // ตรวจสอบว่ามีข้อมูล JSON ในคอลัมน์ B หรือไม่
                if (!row.c[1]?.v) {
                    console.error("❌ ข้อมูลแถวไม่มีข้อมูล JSON ในคอลัมน์ B");
                    return;
                }

                // พยายามแปลงข้อมูล JSON จากคอลัมน์ B
                let jsonData;
                try {
                    jsonData = JSON.parse(row.c[1].v);
                } catch (jsonError) {
                    console.error("❌ ไม่สามารถแปลงข้อมูล JSON ได้:", jsonError);
                    return;
                }

                // ตรวจสอบว่า JSON มีข้อมูลที่จำเป็นหรือไม่
                if (!jsonData || typeof jsonData !== 'object') {
                    console.error("❌ ข้อมูล JSON ไม่ถูกต้อง");
                    return;
                }

                // ดึงวันที่จากแถวข้อมูล (ถ้ามี)
                let rowDate = null;
                if (row.c[0]?.v) {
                    // ถ้ามีข้อมูลในคอลัมน์ A (วันที่)
                    if (typeof row.c[0].v === 'string') {
                        rowDate = row.c[0].v;
                    } else if (row.c[0].v instanceof Date) {
                        rowDate = row.c[0].v.toISOString().split('T')[0];
                    }
                }

                // ตรวจสอบว่ามีข้อมูล Sheet1 หรือไม่
                if (jsonData.ข้อมูลSheet1 && Array.isArray(jsonData.ข้อมูลSheet1)) {
                    // ประมวลผลข้อมูลจาก Sheet1 (เครื่องบิน)
                    processAircraftData(jsonData.ข้อมูลSheet1, "aircraft", dataArray, rowDate);
                }

                // ตรวจสอบว่ามีข้อมูล Sheet2 (เฮลิคอปเตอร์) หรือไม่
                if (jsonData.ข้อมูลSheet2 && Array.isArray(jsonData.ข้อมูลSheet2)) {
                    // ประมวลผลข้อมูลจาก Sheet2 (เฮลิคอปเตอร์)
                    processAircraftData(jsonData.ข้อมูลSheet2, "helicopter", dataArray, rowDate);
                }
            } catch (error) {
                console.error("❌ เกิดข้อผิดพลาดในการประมวลผลข้อมูลแถว:", error);
            }
        }

        // ฟังก์ชันประมวลผลข้อมูลเครื่องบิน
        function processAircraftData(aircraftArray, type, targetArray = null, currentSelectedDate = null) {
            if (!aircraftArray || !Array.isArray(aircraftArray) || aircraftArray.length === 0) {
                console.error(`❌ ข้อมูล ${type} ไม่ถูกต้องหรือไม่มีข้อมูล`);
                return;
            }
            
            // ใช้ targetArray ถ้ามีการระบุ มิฉะนั้นใช้ flightData
            const dataArray = targetArray || flightData;
            
            // ใช้วันที่ปัจจุบันถ้าไม่มีการระบุวันที่
            const selectedDate = currentSelectedDate || new Date().toISOString().split('T')[0];
            
            // วนลูปเพื่อเพิ่มข้อมูลเครื่องบินแต่ละลำ
            aircraftArray.forEach((aircraft) => {
                try {
                    // ตรวจสอบว่ามีข้อมูลพื้นฐานที่จำเป็นหรือไม่
                    if (type === "aircraft" && !aircraft["แบบเครื่องบิน"] && !aircraft["เครื่องบิน"]) {
                        return; // ข้ามข้อมูลนี้
                    } else if (type === "helicopter" && !aircraft["แบบเครื่องบิน"] && !aircraft["หมายเลข"]) {
                        return; // ข้ามข้อมูลนี้
                    }

                    // ดึงข้อมูลจาก JSON ตามโครงสร้างที่กำหนด
                    const name = aircraft["แบบเครื่องบิน"] || "";
                    const aircraftNumber = type === "aircraft" ? (aircraft["เครื่องบิน"] || "") : (aircraft["หมายเลข"] || "");
                    const remainingHours = type === "aircraft" ? (aircraft["ชั่วโมงเครื่องบิน"] || "") : (aircraft["ชั่วโมง"] || "");
                    const missionBase = aircraft["ภารกิจ/ฐานที่ตั้ง"] || "กรุงเทพฯ";
                    const status = aircraft["สภาพ"] ? (aircraft["สภาพ"].toString().toLowerCase() === "yes" ? "yes" : "no") : "no";
                    // เก็บข้อมูลวันที่เพื่อตรวจสอบ
                    const dataDate = targetArray === window.nextDayData ? window.nextDayDate : (selectedDate || new Date().toISOString().split('T')[0]);
                    
                    // เก็บข้อมูลเพิ่มเติมเพื่อระบุว่าเป็นข้อมูลของวันถัดไปหรือไม่
                    const isNextDayData = targetArray === window.nextDayData;

                    // สร้างข้อมูลสำหรับการแสดงผล
                    dataArray.push({
                        name: name || '-',
                        aircraftNumber: aircraftNumber || '-',
                        remainingHours: remainingHours || '-',
                        missionBase: missionBase || '-',
                        status: status || 'no',
                        type: type || 'aircraft',
                        dataDate: dataDate, // เพิ่มข้อมูลวันที่เพื่อตรวจสอบ
                        isNextDayData: isNextDayData // เพิ่มข้อมูลว่าเป็นข้อมูลของวันถัดไปหรือไม่
                    });
                } catch (error) {
                    console.error(`❌ เกิดข้อผิดพลาดในการประมวลผลข้อมูล ${type}:`, error);
                }
            });
        }

        // ตัวแปรเก็บการเรียงลำดับปัจจุบัน
        let currentSort = {
            field: 'name',
            direction: 'asc'
        };
        
        // ฟังก์ชันเรียงข้อมูล
        function sortData(field) {
            // ถ้าคลิกฟิลด์เดิม ให้สลับทิศทางการเรียง
            if (field === currentSort.field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // ถ้าคลิกฟิลด์ใหม่ ให้เรียงจากน้อยไปมาก
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            // เรียงข้อมูลตามฟิลด์และทิศทางที่กำหนด
            flightData.sort((a, b) => {
                let valueA, valueB;
                
                // ดึงค่าตามฟิลด์ที่ต้องการเรียง
                if (field === 'remainingHours') {
                    // แปลงชั่วโมงเป็นตัวเลขเพื่อเรียงลำดับ
                    valueA = parseFloat(a.remainingHours) || 0;
                    valueB = parseFloat(b.remainingHours) || 0;
                } else {
                    valueA = a[field] || '';
                    valueB = b[field] || '';
                    
                    // ถ้าเป็นข้อความ ให้เปรียบเทียบแบบข้อความ
                    if (typeof valueA === 'string' && typeof valueB === 'string') {
                        valueA = valueA.toLowerCase();
                        valueB = valueB.toLowerCase();
                    }
                }
                
                // เรียงลำดับตามทิศทางที่กำหนด
                if (currentSort.direction === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
            
            // สร้าง dashboard ใหม่หลังจากเรียงข้อมูล
            renderDashboard();
        }
        
        // ฟังก์ชันสร้าง dashboard
        function renderDashboard() {
            console.log("🔄 กำลังสร้าง dashboard ใหม่...");
            
            // เพิ่ม event listener สำหรับการเปลี่ยนขนาดหน้าจอ
            window.addEventListener('resize', function() {
                // ถ้ามีการเปลี่ยนขนาดหน้าจอ ให้สร้าง dashboard ใหม่
                clearTimeout(window.resizeTimer);
                window.resizeTimer = setTimeout(function() {
                    renderDashboard();
                }, 250);
            });
            
            const dashboardContainer = document.getElementById('dashboard');
            
            // Check if dashboard container exists
            if (!dashboardContainer) {
                console.error('Dashboard container not found');
                return;
            }
            
            // ล้างข้อมูลเดิมก่อน
            dashboardContainer.innerHTML = "";
            
            // ตรวจสอบว่ามีข้อมูลหรือไม่
            if (!flightData || flightData.length === 0) {
                dashboardContainer.innerHTML = "<div class='loading'>ไม่พบข้อมูลเครื่องบิน</div>";
                console.log("⚠️ ไม่พบข้อมูลเครื่องบิน");
                return;
            }
            
            console.log(`📊 กำลังแสดงข้อมูลเครื่องบิน ${flightData.length} รายการ`);
            if (window.nextDayData && window.nextDayData.length > 0) {
                console.log(`📊 มีข้อมูลวันถัดไป ${window.nextDayData.length} รายการ`);
            }
            
            // อัปเดตข้อมูลสรุป
            let availableCount = 0;
            let unavailableCount = 0;
            
            if (flightData && flightData.length > 0) {
                flightData.forEach(aircraft => {
                    if (aircraft.status === 'yes') availableCount++;
                    else unavailableCount++;
                });
                
                try {
                    const totalElement = document.getElementById('totalAircraft');
                    const availableElement = document.getElementById('availableAircraft');
                    const unavailableElement = document.getElementById('unavailableAircraft');
                    
                    if (totalElement) totalElement.textContent = flightData.length;
                    if (availableElement) availableElement.textContent = availableCount;
                    if (unavailableElement) unavailableElement.textContent = unavailableCount;
                } catch (error) {
                    console.error('Error updating summary counts:', error);
                }
            }

            // สร้างส่วนหัวของตาราง
            const headerRow = document.createElement('div');
            headerRow.className = 'dashboard-header';
            
            // สร้างข้อความแสดงจำนวนรายการ
            const headerTitle = document.createElement('div');
            
            // ใช้ตัวแปรสถานะการใช้ข้อมูลจากวันที่ใกล้เคียง
            const selectedDate = document.getElementById('dateSelector').value;
            
            if (isUsingNearbyDate) {
                // สร้างข้อความหลัก
                headerTitle.innerHTML = `ข้อมูลชั่วโมงบินคงเหลือ (${flightData.length} รายการ)`;
                
                // เพิ่มข้อความแจ้งเตือนว่ากำลังใช้ข้อมูลจากวันที่ใกล้เคียง
                const noticeSpan = document.createElement('span');
                noticeSpan.className = 'closest-date-notice';
                noticeSpan.innerHTML = `<i class="fas fa-info-circle"></i> ไม่พบข้อมูลสำหรับวันที่ ${selectedDate} - กำลังแสดงข้อมูลจากวันที่ ${nearbyDateUsed}`;
                headerTitle.appendChild(document.createElement('br'));
                headerTitle.appendChild(noticeSpan);
            } else {
                headerTitle.textContent = `ข้อมูลชั่วโมงบินคงเหลือ (${flightData.length} รายการ)`;
                
                // เพิ่มข้อความแจ้งเตือนว่ากำลังแสดงข้อมูลวันถัดไปด้วย
                if (window.nextDayData && window.nextDayData.length > 0) {
                    const nextDayNotice = document.createElement('span');
                    nextDayNotice.style.fontSize = '0.8em';
                    nextDayNotice.style.color = '#0066cc';
                    nextDayNotice.style.marginLeft = '10px';
                    nextDayNotice.innerHTML = `<i class="fas fa-arrow-right"></i> แสดงชั่วโมงบินวันถัดไป (${window.nextDayDate})`;
                    
                    headerTitle.appendChild(document.createElement('br'));
                    headerTitle.appendChild(nextDayNotice);
                }
            }
            
            // สร้างปุ่มสำหรับเรียงลำดับ
            const sortControls = document.createElement('div');
            sortControls.className = 'sort-controls';
            
            // ปุ่มเรียงตามชื่อเครื่องบิน
            const sortByName = document.createElement('button');
            sortByName.className = `sort-btn ${currentSort.field === 'name' ? 'active' : ''}`;
            sortByName.innerHTML = `<i class="fas fa-sort-alpha-${currentSort.field === 'name' && currentSort.direction === 'desc' ? 'down' : 'up'}"></i> ชื่อ`;
            sortByName.addEventListener('click', () => sortData('name'));
            
            // ปุ่มเรียงตามหมายเลขเครื่องบิน
            const sortByNumber = document.createElement('button');
            sortByNumber.className = `sort-btn ${currentSort.field === 'aircraftNumber' ? 'active' : ''}`;
            sortByNumber.innerHTML = `<i class="fas fa-sort-numeric-${currentSort.field === 'aircraftNumber' && currentSort.direction === 'desc' ? 'down' : 'up'}"></i> หมายเลข`;
            sortByNumber.addEventListener('click', () => sortData('aircraftNumber'));
            
            // ปุ่มเรียงตามชั่วโมงบิน
            const sortByHours = document.createElement('button');
            sortByHours.className = `sort-btn ${currentSort.field === 'remainingHours' ? 'active' : ''}`;
            sortByHours.innerHTML = `<i class="fas fa-sort-numeric-${currentSort.field === 'remainingHours' && currentSort.direction === 'desc' ? 'down' : 'up'}"></i> ชั่วโมงบิน`;
            sortByHours.addEventListener('click', () => sortData('remainingHours'));
            
            // เพิ่มปุ่มเรียงลำดับลงในส่วนควบคุมการเรียง
            sortControls.appendChild(sortByName);
            sortControls.appendChild(sortByNumber);
            sortControls.appendChild(sortByHours);
            
            // เพิ่มส่วนต่างๆ ลงในส่วนหัว
            headerRow.appendChild(headerTitle);
            headerRow.appendChild(sortControls);
            
            dashboardContainer.appendChild(headerRow);

            // สร้างแถวสำหรับแต่ละเครื่องบิน
            flightData.forEach((aircraft, index) => {
                const row = document.createElement('div');
                row.className = `dashboard-row ${index % 2 === 0 ? 'even' : ''}`;
                row.dataset.status = aircraft.status; // เพิ่ม data attribute สำหรับการกรอง
                
                // เพิ่ม data attribute สำหรับประเภทเครื่องบิน (aircraft หรือ helicopter)
                if (aircraft.type && aircraft.type.toLowerCase() === 'helicopter') {
                    row.dataset.type = 'helicopter';
                } else {
                    row.dataset.type = 'aircraft';
                }

                // สร้างรูปภาพเครื่องบิน
                const aircraftImage = document.createElement('img');
                aircraftImage.className = 'aircraft-image';
                
                // ใช้ฟังก์ชันเพื่อหารูปภาพที่เหมาะสมสำหรับเครื่องบินแต่ละรุ่น
                try {
                    const imageInfo = getAircraftImage(aircraft);
                    aircraftImage.src = imageInfo.src;
                    aircraftImage.alt = imageInfo.alt;
                } catch (error) {
                    console.error("Error getting aircraft image:", error);
                    // ใช้รูปภาพทั่วไปในกรณีที่เกิดข้อผิดพลาด
                    if (aircraft.type && aircraft.type === 'helicopter') {
                        aircraftImage.src = 'helicopter.svg';
                        aircraftImage.alt = 'Helicopter';
                    } else {
                        aircraftImage.src = 'airplane.svg';
                        aircraftImage.alt = 'Aircraft';
                    }
                }
                
                // ถ้ารูปภาพโหลดไม่สำเร็จ ให้ใช้รูปภาพทั่วไปแทน
                aircraftImage.onerror = function() {
                    if (aircraft.type && aircraft.type === 'helicopter') {
                        this.src = 'helicopter.svg';
                    } else {
                        this.src = 'airplane.svg';
                    }
                    // ป้องกันการเรียก onerror ซ้ำ
                    this.onerror = null;
                };
                
                // สร้างส่วนข้อมูลเครื่องบิน
                const aircraftInfo = document.createElement('div');
                aircraftInfo.className = 'aircraft-info';
                
                // ชื่อและหมายเลขเครื่องบิน
                const aircraftName = document.createElement('div');
                aircraftName.className = 'aircraft-name';
                aircraftName.textContent = aircraft.name || '-';
                
                const aircraftNumber = document.createElement('div');
                aircraftNumber.className = 'aircraft-number';
                aircraftNumber.textContent = aircraft.aircraftNumber || '-';
                
                // สถานะเครื่องบิน
                const statusIndicator = document.createElement('span');
                statusIndicator.className = `status-indicator ${aircraft.status === 'yes' ? 'status-available' : 'status-unavailable'}`;
                
                // ในโหมดมือถือแสดงเฉพาะไอคอน
                const isMobile = window.innerWidth <= 768;
                statusIndicator.innerHTML = aircraft.status === 'yes' ? 
                    (isMobile ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-check-circle"></i> พร้อม') : 
                    (isMobile ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-times-circle"></i> ไม่พร้อม');
                
                // รวมชื่อ หมายเลข และสถานะ
                const nameContainer = document.createElement('div');
                nameContainer.className = 'aircraft-name-container';
                nameContainer.appendChild(aircraftName);
                nameContainer.appendChild(aircraftNumber);
                
                aircraftInfo.appendChild(nameContainer);
                aircraftInfo.appendChild(statusIndicator);
                
                // สร้างส่วนรายละเอียดเครื่องบิน
                const aircraftDetails = document.createElement('div');
                aircraftDetails.className = 'aircraft-details';
                
                // สร้างแถวข้อมูลแบบกระชับ
                const infoRow = document.createElement('div');
                infoRow.className = 'info-row';
                infoRow.style.display = 'flex';
                infoRow.style.gap = '5px';
                infoRow.style.flexWrap = 'wrap';
                infoRow.style.alignItems = 'center';
                infoRow.style.overflow = 'hidden';
                infoRow.style.flex = '1';
                infoRow.style.minWidth = '0';
                
                // ชั่วโมงบินคงเหลือ
                const hoursItem = document.createElement('div');
                hoursItem.className = 'info-item';
                hoursItem.style.backgroundColor = 'rgba(26, 115, 232, 0.08)';
                hoursItem.style.fontWeight = 'bold';
                
                const hoursLabel = document.createElement('span');
                hoursLabel.className = 'info-label';
                hoursLabel.textContent = 'ชม.';
                
                const hoursValue = document.createElement('span');
                hoursValue.className = 'hours-value';
                
                // ตรวจสอบว่ามีข้อมูลวันถัดไปหรือไม่
                if (window.nextDayData && window.nextDayData.length > 0) {
                    // หาข้อมูลเครื่องบินลำเดียวกันในวันถัดไป
                    const nextDayAircraft = window.nextDayData.find(item => 
                        item.aircraftNumber === aircraft.aircraftNumber && 
                        item.name === aircraft.name);
                    
                    if (nextDayAircraft) {
                        // คำนวณผลต่างของชั่วโมงบิน
                        let hoursDiff = '';
                        let diffDisplay = '';
                        
                        // ตรวจสอบว่ามีข้อมูลชั่วโมงบินทั้งสองวันหรือไม่
                        if (aircraft.remainingHours && nextDayAircraft.remainingHours && 
                            aircraft.remainingHours !== '-' && nextDayAircraft.remainingHours !== '-') {
                            
                            // ตรวจสอบว่าเป็นเครื่องบิน SKA-350 หรือไม่
                            let isSKA = false;
                            if (aircraft.name) {
                                const nameStr = String(aircraft.name);
                                if (nameStr.includes('SKA-350') || nameStr.includes('SKA350') || nameStr.includes('SKA')) {
                                    isSKA = true;
                                }
                            }
                            
                            if (isSKA) {
                                // สำหรับ SKA-350 ใช้การคำนวณแบบคณิตศาสตร์ธรรมดา
                                try {
                                    // แปลงข้อมูลเป็นตัวเลขทศนิยม
                                    let current = 0;
                                    let nextDay = 0;
                                    
                                    try {
                                        // Handle different formats safely
                                        if (typeof aircraft.remainingHours === 'string') {
                                            current = parseFloat(aircraft.remainingHours.replace(':', '.')) || 0;
                                        } else if (typeof aircraft.remainingHours === 'number') {
                                            current = aircraft.remainingHours;
                                        }
                                        
                                        if (typeof nextDayAircraft.remainingHours === 'string') {
                                            nextDay = parseFloat(nextDayAircraft.remainingHours.replace(':', '.')) || 0;
                                        } else if (typeof nextDayAircraft.remainingHours === 'number') {
                                            nextDay = nextDayAircraft.remainingHours;
                                        }
                                    } catch (e) {
                                        console.error('Error parsing hours:', e);
                                    }
                                    
                                    // คำนวณผลต่าง
                                    const diff = nextDay - current;
                                    
                                    if (diff !== 0) {
                                        // แสดงผลต่างในรูปแบบทศนิยม 1 ตำแหน่ง
                                        const diffAbs = Math.abs(diff).toFixed(1);
                                        const sign = diff > 0 ? '+' : '-';
                                        const color = diff > 0 ? '#2ecc71' : '#e74c3c';
                                        diffDisplay = `<span class="hours-diff ${diff > 0 ? 'positive' : 'negative'}">${sign}${diffAbs}</span>`;
                                    }
                                } catch (error) {
                                    console.error('เกิดข้อผิดพลาดในการคำนวณสำหรับ SKA-350:', error);
                                }
                            } else {
                                // สำหรับเครื่องบินทั่วไป ใช้การคำนวณแบบ HH:MM
                                function timeToMinutes(timeStr) {
                                    // Check if timeStr is valid
                                    if (!timeStr || typeof timeStr !== 'string') {
                                        return 0;
                                    }
                                    
                                    // Handle different formats
                                    const parts = timeStr.split(':');
                                    if (parts.length === 2) {
                                        // Make sure parts are valid numbers
                                        const hours = parseInt(parts[0]) || 0;
                                        const minutes = parseInt(parts[1]) || 0;
                                        return hours * 60 + minutes;
                                    } else if (!isNaN(timeStr)) {
                                        // If it's just a number, treat as hours
                                        return parseFloat(timeStr) * 60;
                                    }
                                    return 0;
                                }
                                
                                // แปลงนาทีเป็นรูปแบบ HH:MM
                                function minutesToTime(minutes) {
                                    if (isNaN(minutes)) {
                                        return "0:00";
                                    }
                                    const hours = Math.floor(Math.abs(minutes) / 60);
                                    const mins = Math.abs(minutes) % 60;
                                    return `${hours}:${mins.toString().padStart(2, '0')}`;
                                }
                                
                                const currentMinutes = timeToMinutes(aircraft.remainingHours);
                                const nextDayMinutes = timeToMinutes(nextDayAircraft.remainingHours);
                                const diffMinutes = currentMinutes - nextDayMinutes;
                                
                                if (diffMinutes !== 0) {
                                    hoursDiff = minutesToTime(diffMinutes);
                                    const sign = diffMinutes > 0 ? '-' : '+';
                                    diffDisplay = `<span class="hours-diff ${diffMinutes > 0 ? 'negative' : 'positive'}">${sign}${hoursDiff}</span>`;
                                }
                            }
                        }
                        
                        // แสดงชั่วโมงบินของวันที่เลือกและผลต่าง
                        hoursValue.innerHTML = `${aircraft.remainingHours || '-'} ${diffDisplay}`;  // แสดงเฉพาะผลต่าง
                    } else {
                        // ไม่พบข้อมูลเครื่องบินลำเดียวกันในวันถัดไป
                        hoursValue.textContent = aircraft.remainingHours || '-';
                    }
                } else {
                    // ไม่มีข้อมูลวันถัดไป
                    hoursValue.textContent = aircraft.remainingHours || '-';
                    
                    // ถ้ามีการพยายามโหลดข้อมูลวันถัดไปแต่ไม่พบ ให้แสดง log
                    if (window.nextDayDate) {
                        console.log(`ℹ️ แสดงเฉพาะชั่วโมงบินของวันที่เลือก (${aircraft.aircraftNumber}) เนื่องจากไม่พบข้อมูลวันถัดไป`);
                    }
                }
                
                hoursItem.appendChild(hoursLabel);
                hoursItem.appendChild(hoursValue);
                
                // ภารกิจ/ฐานที่ตั้ง
                const missionItem = document.createElement('div');
                missionItem.className = 'info-item';
                
                const missionLabel = document.createElement('span');
                missionLabel.className = 'info-label';
                missionLabel.textContent = 'ภารกิจ:';
                
                const missionValue = document.createElement('span');
                missionValue.className = 'info-value';
                missionValue.textContent = aircraft.missionBase || '-';
                
                missionItem.appendChild(missionLabel);
                missionItem.appendChild(missionValue);
                
                // เพิ่มรายละเอียดลงในแถวข้อมูล
                infoRow.appendChild(hoursItem);
                infoRow.appendChild(missionItem);
                
                // เพิ่มแถวข้อมูลลงในส่วนรายละเอียด
                aircraftDetails.appendChild(infoRow);
                
                // ไม่ต้องเพิ่มรายละเอียดลงในส่วนข้อมูลเครื่องบินแบบเดิมอีกต่อไป
                // เนื่องจากเราได้สร้างแถวข้อมูลใหม่ที่แสดงข้อมูลทั้งหมดแล้ว
                
                // สร้างแถวหลักสำหรับข้อมูลพื้นฐาน
                const mainRow = document.createElement('div');
                mainRow.className = 'aircraft-main-row';
                
                // สร้างข้อมูลพื้นฐานใหม่สำหรับแถวหลัก
                const mobileAircraftImage = document.createElement('img');
                mobileAircraftImage.className = 'aircraft-image';
                
                // ใช้ฟังก์ชันเพื่อหารูปภาพที่เหมาะสมสำหรับเครื่องบินแต่ละรุ่น
                try {
                    const imageInfo = getAircraftImage(aircraft);
                    mobileAircraftImage.src = imageInfo.src;
                    mobileAircraftImage.alt = imageInfo.alt;
                } catch (error) {
                    console.error("Error getting aircraft image:", error);
                    // ใช้รูปภาพทั่วไปในกรณีที่เกิดข้อผิดพลาด
                    if (aircraft.type && aircraft.type === 'helicopter') {
                        mobileAircraftImage.src = 'helicopter.svg';
                    } else {
                        mobileAircraftImage.src = 'airplane.svg';
                    }
                }
                
                mobileAircraftImage.alt = aircraft.name || 'Aircraft';
                
                // กำหนด onerror เพื่อแสดงรูปภาพเริ่มต้นถ้าโหลดรูปภาพไม่สำเร็จ
                mobileAircraftImage.onerror = function() {
                    if (aircraft.type && aircraft.type === 'helicopter') {
                        this.src = 'helicopter.svg';
                    } else {
                        this.src = 'airplane.svg';
                    }
                    this.onerror = null;
                };
                
                // สร้างข้อมูลทั้งหมดในบรรทัดเดียว
                // ชื่อและหมายเลขเครื่องบิน
                const mobileNameContainer = document.createElement('div');
                mobileNameContainer.className = 'aircraft-name-container';
                mobileNameContainer.style.display = 'flex';
                mobileNameContainer.style.flexDirection = 'column';
                
                const mobileAircraftName = document.createElement('div');
                mobileAircraftName.className = 'aircraft-name';
                mobileAircraftName.textContent = aircraft.name || '-';
                
                const mobileAircraftNumber = document.createElement('div');
                mobileAircraftNumber.className = 'aircraft-number';
                mobileAircraftNumber.textContent = aircraft.aircraftNumber || '-';
                
                mobileNameContainer.appendChild(mobileAircraftName);
                mobileNameContainer.appendChild(mobileAircraftNumber);
                
                // สถานะเครื่องบิน
                const mobileStatusIndicator = document.createElement('span');
                mobileStatusIndicator.className = `status-indicator ${aircraft.status === 'yes' ? 'status-available' : 'status-unavailable'}`;
                mobileStatusIndicator.style.marginLeft = '4px';
                
                // แสดงเฉพาะไอคอน
                mobileStatusIndicator.innerHTML = aircraft.status === 'yes' ? 
                    '<i class="fas fa-check-circle"></i>' : 
                    '<i class="fas fa-times-circle"></i>';
                
                // เพิ่มข้อมูลพื้นฐานลงในแถวหลัก
                mainRow.appendChild(mobileNameContainer);
                mainRow.appendChild(mobileAircraftImage);
                mainRow.appendChild(mobileStatusIndicator);
                
                // ชั่วโมงบินคงเหลือ - แบบกระชับ
                const mobileHoursItem = document.createElement('div');
                mobileHoursItem.className = 'info-item hours-item';
                mobileHoursItem.style.marginLeft = 'auto'; // ให้ชิดขวา
                mobileHoursItem.style.minWidth = '120px'; // กำหนดความกว้างให้คงที่
                
                const mobileHoursValue = document.createElement('span');
                mobileHoursValue.className = 'info-value hours-value';
                
                // ตรวจสอบว่ามีข้อมูลวันถัดไปหรือไม่
                if (window.nextDayData && window.nextDayData.length > 0) {
                    // หาข้อมูลเครื่องบินลำเดียวกันในวันถัดไป
                    const nextDayAircraft = window.nextDayData.find(item => 
                        item.aircraftNumber === aircraft.aircraftNumber && 
                        item.name === aircraft.name);
                    
                    if (nextDayAircraft) {
                        // คำนวณผลต่างของชั่วโมงบิน
                        let hoursDiff = '';
                        let diffDisplay = '';
                        
                        // ตรวจสอบว่ามีข้อมูลชั่วโมงบินทั้งสองวันหรือไม่
                        if (aircraft.remainingHours && nextDayAircraft.remainingHours && 
                            aircraft.remainingHours !== '-' && nextDayAircraft.remainingHours !== '-') {
                            
                            // ตรวจสอบว่าเป็นเครื่องบิน SKA-350 หรือไม่
                            let isSKA = false;
                            if (aircraft.name) {
                                const nameStr = String(aircraft.name);
                                if (nameStr.includes('SKA-350') || nameStr.includes('SKA350') || nameStr.includes('SKA')) {
                                    isSKA = true;
                                }
                            }
                            
                            if (isSKA) {
                                try {
                                    // แปลงข้อมูลเป็นตัวเลขทศนิยม
                                    let current = 0;
                                    let nextDay = 0;
                                    
                                    try {
                                        // Handle different formats safely
                                        if (typeof aircraft.remainingHours === 'string') {
                                            current = parseFloat(aircraft.remainingHours.replace(':', '.')) || 0;
                                        } else if (typeof aircraft.remainingHours === 'number') {
                                            current = aircraft.remainingHours;
                                        }
                                        
                                        if (typeof nextDayAircraft.remainingHours === 'string') {
                                            nextDay = parseFloat(nextDayAircraft.remainingHours.replace(':', '.')) || 0;
                                        } else if (typeof nextDayAircraft.remainingHours === 'number') {
                                            nextDay = nextDayAircraft.remainingHours;
                                        }
                                    } catch (e) {
                                        console.error('Error parsing hours:', e);
                                    }
                                    
                                    // คำนวณผลต่าง
                                    const diff = nextDay - current;
                                    
                                    if (diff !== 0) {
                                        // แสดงผลต่างในรูปแบบทศนิยม 1 ตำแหน่ง
                                        const diffAbs = Math.abs(diff).toFixed(1);
                                        const sign = diff > 0 ? '+' : '-';
                                        diffDisplay = `<span class="hours-diff ${diff > 0 ? 'positive' : 'negative'}">${sign}${diffAbs}</span>`;
                                    }
                                } catch (error) {
                                    console.error('เกิดข้อผิดพลาดในการคำนวณสำหรับ SKA-350:', error);
                                }
                            } else {
                                try {
                                    function timeToMinutes(timeStr) {
                                        if (!timeStr || timeStr === '-') return 0;
                                        
                                        // แปลงรูปแบบ HH:MM เป็นนาที
                                        const parts = timeStr.split(':');
                                        if (parts.length === 2) {
                                            const hours = parseInt(parts[0]);
                                            const minutes = parseInt(parts[1]);
                                            if (!isNaN(hours) && !isNaN(minutes)) {
                                                return hours * 60 + minutes;
                                            }
                                        }
                                        return 0;
                                    }
                                    
                                    function minutesToTime(minutes) {
                                        if (isNaN(minutes)) {
                                            return "0:00";
                                        }
                                        const hours = Math.floor(Math.abs(minutes) / 60);
                                        const mins = Math.abs(minutes) % 60;
                                        return `${hours}:${mins.toString().padStart(2, '0')}`;
                                    }
                                    
                                    const currentMinutes = timeToMinutes(aircraft.remainingHours);
                                    const nextDayMinutes = timeToMinutes(nextDayAircraft.remainingHours);
                                    const diffMinutes = currentMinutes - nextDayMinutes;
                                    
                                    if (diffMinutes !== 0) {
                                        hoursDiff = minutesToTime(diffMinutes);
                                        const sign = diffMinutes > 0 ? '-' : '+';
                                        diffDisplay = `<span class="hours-diff ${diffMinutes > 0 ? 'negative' : 'positive'}">${sign}${hoursDiff}</span>`;
                                    }
                                } catch (error) {
                                    console.error('เกิดข้อผิดพลาดในการคำนวณชั่วโมงบิน:', error);
                                }
                            }
                        }
                        
                        // แสดงชั่วโมงบินของวันที่เลือก
                        mobileHoursValue.innerHTML = `<div><strong>${aircraft.remainingHours || '-'}</strong></div>`;
                        
                        // สร้างคอลัมน์ใหม่สำหรับผลต่าง
                        const diffColumn = document.createElement('div');
                        diffColumn.className = 'info-item diff-item';
                        diffColumn.style.marginLeft = '4px';
                        diffColumn.innerHTML = diffDisplay;
                        
                        // เก็บไว้ใช้ต่อ
                        aircraft.diffColumn = diffColumn;
                    } else {
                        // ไม่พบข้อมูลเครื่องบินลำเดียวกันในวันถัดไป
                        mobileHoursValue.innerHTML = `<div><strong>${aircraft.remainingHours || '-'}</strong></div>`;
                    }
                } else {
                    // ไม่มีข้อมูลวันถัดไป
                    mobileHoursValue.innerHTML = `<div><strong>${aircraft.remainingHours || '-'}</strong></div>`;
                }
                
                // จัดรูปแบบใหม่ให้น่าสนใจ
                const mobileHoursLabel = document.createElement('div');
                mobileHoursLabel.style.fontSize = '0.7rem';
                mobileHoursLabel.style.color = '#666';
                mobileHoursLabel.style.marginBottom = '2px';
                mobileHoursLabel.textContent = "ชั่วโมงบิน";
                
                // เพิ่ม label ก่อน
                mobileHoursItem.appendChild(mobileHoursLabel);
                
                // จากนั้นเพิ่ม value
                mobileHoursItem.appendChild(mobileHoursValue);
                
                // ภารกิจ/ฐานที่ตั้ง - แบบกระชับ
                const mobileMissionItem = document.createElement('div');
                mobileMissionItem.className = 'info-item mission-item';
                mobileMissionItem.style.marginLeft = '8px';
                
                const mobileMissionLabel = document.createElement('div');
                mobileMissionLabel.style.fontSize = '0.7rem';
                mobileMissionLabel.style.color = '#666';
                mobileMissionLabel.style.marginBottom = '2px';
                mobileMissionLabel.textContent = "ภารกิจ";
                
                const mobileMissionValue = document.createElement('span');
                mobileMissionValue.className = 'info-value';
                mobileMissionValue.innerHTML = `<strong>${aircraft.missionBase || '-'}</strong>`;
                
                mobileMissionItem.appendChild(mobileMissionLabel);
                
                mobileMissionItem.appendChild(mobileMissionValue);
                
                // เพิ่มรายละเอียดลงในแถวหลัก (ในบรรทัดเดียวกัน)
                mainRow.appendChild(mobileMissionItem);
                
                // เพิ่ม spacer เพื่อให้ชั่วโมงบินอยู่ด้านขวา
                const spacer = document.createElement('div');
                spacer.style.flexGrow = '1';
                mainRow.appendChild(spacer);
                
                // เพิ่มชั่วโมงบินด้านขวา
                mainRow.appendChild(mobileHoursItem);
                
                // เพิ่มคอลัมน์ผลต่าง (ถ้ามี)
                if (aircraft.diffColumn) {
                    mainRow.appendChild(aircraft.diffColumn);
                }
                
                // ปรับความกว้างของแถวให้เต็มพื้นที่
                mainRow.style.width = '100%';
                mainRow.style.display = 'flex';
                mainRow.style.alignItems = 'center';
                mainRow.style.justifyContent = 'flex-start';
                
                // ตรวจสอบว่ามีข้อมูลที่จำเป็นหรือไม่
                if (!aircraft.remainingHours || aircraft.remainingHours === '-') {
                    console.log("ไม่มีข้อมูลชั่วโมงบินสำหรับ:", aircraft.aircraftNumber);
                }
                
                // เพิ่มแถวหลักลงในแถว row
                row.appendChild(mainRow);
                
                // เพิ่มแถวลงใน dashboard
                dashboardContainer.appendChild(row);
            });
        }
        
        // ตัวแปรเก็บค่าตัวกรองปัจจุบัน
        let currentFilter = 'all';
        let currentSearchText = '';
        
        // ฟังก์ชันกรองข้อมูล
        function filterData(filter) {
            currentFilter = filter;
            applyFilters();
        }
        
        // ฟังก์ชันค้นหา
        function searchData(searchText) {
            currentSearchText = searchText;
            applyFilters();
        }
        
        // ฟังก์ชันรวมสำหรับใช้ทั้งการกรองและการค้นหา
        function applyFilters() {
            const rows = document.querySelectorAll('.dashboard-row');
            let availableCount = 0;
            let unavailableCount = 0;
            let totalVisible = 0;
            
            // แยกคำค้นหาออกเป็นคำย่อยๆ เมื่อมีช่องว่าง
            const searchTerms = currentSearchText.split(/\s+/).filter(term => term.length > 0);
            
            rows.forEach(row => {
                let matchesFilter = false;
                let matchesSearch = true;
                let matchesType = false;
                
                // ตรวจสอบตัวกรองสถานะ
                if (currentFilter === 'all') {
                    matchesFilter = true;
                } else if (currentFilter === 'available' && row.dataset.status === 'yes') {
                    matchesFilter = true;
                } else if (currentFilter === 'unavailable' && row.dataset.status === 'no') {
                    matchesFilter = true;
                } else if (currentFilter === 'aircraft' && row.dataset.type === 'aircraft') {
                    matchesFilter = true;
                } else if (currentFilter === 'helicopter' && row.dataset.type === 'helicopter') {
                    matchesFilter = true;
                }
                
                // ตรวจสอบการค้นหา
                if (currentSearchText) {
                    const name = row.querySelector('.aircraft-name').textContent.toLowerCase();
                    const number = row.querySelector('.aircraft-number').textContent.toLowerCase();
                    const infoValues = row.querySelectorAll('.info-value');
                    let allText = name + ' ' + number + ' ';
                    
                    // รวมข้อความจากทุก info-value
                    infoValues.forEach(info => {
                        allText += info.textContent.toLowerCase() + ' ';
                    });
                    
                    // ตรวจสอบแบบปกติ (ค้นหาทั้งประโยค)
                    if (allText.includes(currentSearchText)) {
                        matchesSearch = true;
                    } else if (searchTerms.length > 1) {
                        // ตรวจสอบแบบคำต่อคำ (ค้นหาแต่ละคำ)
                        matchesSearch = searchTerms.every(term => allText.includes(term));
                    } else {
                        matchesSearch = false;
                    }
                }
                
                // แสดงหรือซ่อนตามผลการกรองและค้นหา
                if (matchesFilter && matchesSearch) {
                    row.style.display = 'flex';
                    totalVisible++;
                    if (row.dataset.status === 'yes') availableCount++;
                    else unavailableCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // อัปเดตข้อมูลสรุป
            try {
                const totalElement = document.getElementById('totalAircraft');
                const availableElement = document.getElementById('availableAircraft');
                const unavailableElement = document.getElementById('unavailableAircraft');
                
                if (totalElement) totalElement.textContent = totalVisible;
                if (availableElement) availableElement.textContent = availableCount;
                if (unavailableElement) unavailableElement.textContent = unavailableCount;
            } catch (error) {
                console.error('Error updating summary counts in applyFilters:', error);
            }
        }
        
        // ตั้งค่าการค้นหาแบบ real-time
        const searchInput = document.getElementById('searchInput');
        
        if (searchInput) {
            // ค้นหาทันทีเมื่อพิมพ์
            searchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                searchData(searchText);
            });
            
            // ค้นหาเมื่อกด Enter
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    const searchText = this.value.toLowerCase();
                    searchData(searchText);
                }
            });
        }
        
        function searchData(searchText) {
            const rows = document.querySelectorAll('.dashboard-row');
            let availableCount = 0;
            let unavailableCount = 0;
            let totalVisible = 0;
            
            rows.forEach(row => {
                const name = row.querySelector('.aircraft-name').textContent.toLowerCase();
                const number = row.querySelector('.aircraft-number').textContent.toLowerCase();
                // Fix: Get all info-value elements and check each one
                const infoValues = row.querySelectorAll('.info-value');
                let matchFound = false;
                
                // ปรับปรุงคำค้นหาให้รองรับการค้นหาแบบยืดหยุ่น
                const searchTerms = searchText.split(/\s+/).filter(term => term.length > 0);
                
                // Check if name or number matches
                if (name.includes(searchText) || number.includes(searchText)) {
                    matchFound = true;
                } else {
                    // Check if any info-value matches
                    infoValues.forEach(infoValue => {
                        const infoContent = infoValue.textContent.toLowerCase();
                        
                        // ตรวจสอบแบบปกติ (ค้นหาทั้งประโยค)
                        if (infoContent.includes(searchText)) {
                            matchFound = true;
                            return;
                        }
                        
                        // ตรวจสอบแบบคำต่อคำ (ค้นหาแต่ละคำ)
                        if (searchTerms.length > 1) {
                            const allTermsMatch = searchTerms.every(term => infoContent.includes(term));
                            if (allTermsMatch) {
                                matchFound = true;
                                return;
                            }
                        }
                    });
                }
                
                if (matchFound) {
                    row.style.display = 'flex';
                    totalVisible++;
                    if (row.dataset.status === 'yes') availableCount++;
                    else unavailableCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // อัปเดตข้อมูลสรุป
            try {
                const totalElement = document.getElementById('totalAircraft');
                const availableElement = document.getElementById('availableAircraft');
                const unavailableElement = document.getElementById('unavailableAircraft');
                
                if (totalElement) totalElement.textContent = totalVisible;
                if (availableElement) availableElement.textContent = availableCount;
                if (unavailableElement) unavailableElement.textContent = unavailableCount;
            } catch (error) {
                console.error('Error updating summary counts in searchData:', error);
            }
        }
        
        // เพิ่มการตอบสนองต่อปุ่มกรอง
        const filterButtons = document.querySelectorAll('.filter-btn');
        if (filterButtons && filterButtons.length > 0) {
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // ลบคลาส active จากปุ่มทั้งหมด
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    // เพิ่มคลาส active ให้กับปุ่มที่ถูกคลิก
                    this.classList.add('active');
                    
                    const filter = this.dataset.filter;
                    filterData(filter);
                });
            });
        }
    </script>
</body>
</html>